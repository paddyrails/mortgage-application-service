name: 9.3 Create Grafana Dashboards

# ============================================================
# Creates Grafana dashboards for mortgage microservices:
# - Service Overview Dashboard
# - Logs Dashboard
# - Error Analysis Dashboard
# - Per-Service Dashboards
# ============================================================

on:
  workflow_dispatch:
    inputs:
      monitoring_namespace:
        description: "Namespace where Grafana is deployed"
        required: true
        default: "monitoring"
      app_namespace:
        description: "Namespace where microservices are deployed"
        required: true
        default: "mortgage-app"

jobs:
  create-dashboards:
    name: Create Grafana Dashboards
    runs-on: ubuntu-latest

    steps:
      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify=true

      - name: Get Grafana Credentials
        id: grafana
        run: |
          echo "üîç Getting Grafana credentials..."

          GRAFANA_URL=$(oc get route grafana -n ${{ github.event.inputs.monitoring_namespace }} -o jsonpath='{.spec.host}')
          GRAFANA_PASSWORD=$(oc get secret grafana-admin-credentials -n ${{ github.event.inputs.monitoring_namespace }} -o jsonpath='{.data.admin-password}' | base64 -d)

          echo "url=https://${GRAFANA_URL}" >> $GITHUB_OUTPUT
          echo "password=${GRAFANA_PASSWORD}" >> $GITHUB_OUTPUT

          echo "‚úÖ Grafana URL: https://${GRAFANA_URL}"

      - name: Create Mortgage Services Overview Dashboard
        run: |
          echo "üìä Creating Services Overview Dashboard..."

          GRAFANA_URL="${{ steps.grafana.outputs.url }}"
          GRAFANA_PASSWORD="${{ steps.grafana.outputs.password }}"
          APP_NS="${{ github.event.inputs.app_namespace }}"

          cat <<'EOF' > /tmp/dashboard-overview.json
          {
            "dashboard": {
              "id": null,
              "uid": "mortgage-overview",
              "title": "Mortgage Services - Overview",
              "tags": ["mortgage", "overview"],
              "timezone": "browser",
              "schemaVersion": 38,
              "version": 1,
              "refresh": "30s",
              "panels": [
                {
                  "id": 1,
                  "title": "Service Log Volume",
                  "type": "timeseries",
                  "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "sum by (app) (count_over_time({namespace=\"APP_NAMESPACE\"}[1m]))",
                      "legendFormat": "{{app}}",
                      "refId": "A"
                    }
                  ],
                  "fieldConfig": {
                    "defaults": {
                      "custom": {"lineWidth": 2, "fillOpacity": 10}
                    }
                  }
                },
                {
                  "id": 2,
                  "title": "Error Rate by Service",
                  "type": "timeseries",
                  "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "sum by (app) (count_over_time({namespace=\"APP_NAMESPACE\"} |~ \"(?i)error|exception|fail\" [1m]))",
                      "legendFormat": "{{app}}",
                      "refId": "A"
                    }
                  ],
                  "fieldConfig": {
                    "defaults": {
                      "color": {"mode": "palette-classic"},
                      "custom": {"lineWidth": 2, "fillOpacity": 10}
                    }
                  }
                },
                {
                  "id": 3,
                  "title": "Recent Errors",
                  "type": "logs",
                  "gridPos": {"h": 10, "w": 24, "x": 0, "y": 8},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "{namespace=\"APP_NAMESPACE\"} |~ \"(?i)error|exception|fail\"",
                      "refId": "A"
                    }
                  ],
                  "options": {
                    "showTime": true,
                    "showLabels": true,
                    "showCommonLabels": false,
                    "wrapLogMessage": true,
                    "prettifyLogMessage": false,
                    "enableLogDetails": true,
                    "dedupStrategy": "none",
                    "sortOrder": "Descending"
                  }
                },
                {
                  "id": 4,
                  "title": "Log Level Distribution",
                  "type": "piechart",
                  "gridPos": {"h": 8, "w": 8, "x": 0, "y": 18},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "sum by (level) (count_over_time({namespace=\"APP_NAMESPACE\"} | json | level != \"\" [5m]))",
                      "legendFormat": "{{level}}",
                      "refId": "A"
                    }
                  ]
                },
                {
                  "id": 5,
                  "title": "Logs per Service (5m)",
                  "type": "stat",
                  "gridPos": {"h": 8, "w": 16, "x": 8, "y": 18},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "sum by (app) (count_over_time({namespace=\"APP_NAMESPACE\"}[5m]))",
                      "legendFormat": "{{app}}",
                      "refId": "A"
                    }
                  ],
                  "options": {
                    "reduceOptions": {
                      "calcs": ["lastNotNull"],
                      "fields": "",
                      "values": false
                    },
                    "orientation": "horizontal",
                    "textMode": "auto",
                    "colorMode": "value",
                    "graphMode": "area",
                    "justifyMode": "auto"
                  }
                }
              ]
            },
            "overwrite": true
          }
          EOF

          # Replace placeholder with actual namespace
          sed -i "s/APP_NAMESPACE/$APP_NS/g" /tmp/dashboard-overview.json

          # Create dashboard via API
          curl -k -X POST \
            -H "Content-Type: application/json" \
            -u "admin:${GRAFANA_PASSWORD}" \
            -d @/tmp/dashboard-overview.json \
            "${GRAFANA_URL}/api/dashboards/db" && echo "‚úÖ Overview dashboard created" || echo "‚ö†Ô∏è Dashboard may already exist"

      - name: Create Service Logs Dashboard
        run: |
          echo "üìä Creating Service Logs Dashboard..."

          GRAFANA_URL="${{ steps.grafana.outputs.url }}"
          GRAFANA_PASSWORD="${{ steps.grafana.outputs.password }}"
          APP_NS="${{ github.event.inputs.app_namespace }}"

          cat <<'EOF' > /tmp/dashboard-logs.json
          {
            "dashboard": {
              "id": null,
              "uid": "mortgage-logs",
              "title": "Mortgage Services - Logs",
              "tags": ["mortgage", "logs"],
              "timezone": "browser",
              "schemaVersion": 38,
              "version": 1,
              "refresh": "10s",
              "templating": {
                "list": [
                  {
                    "name": "service",
                    "type": "query",
                    "datasource": {"type": "loki", "uid": "loki"},
                    "query": "label_values({namespace=\"APP_NAMESPACE\"}, app)",
                    "refresh": 1,
                    "includeAll": true,
                    "multi": true,
                    "current": {"selected": true, "text": "All", "value": "$__all"}
                  },
                  {
                    "name": "level",
                    "type": "custom",
                    "query": "info,warn,error,debug",
                    "includeAll": true,
                    "multi": true,
                    "current": {"selected": true, "text": "All", "value": "$__all"}
                  },
                  {
                    "name": "search",
                    "type": "textbox",
                    "current": {"selected": false, "text": "", "value": ""}
                  }
                ]
              },
              "panels": [
                {
                  "id": 1,
                  "title": "Live Logs - $service",
                  "type": "logs",
                  "gridPos": {"h": 20, "w": 24, "x": 0, "y": 0},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "{namespace=\"APP_NAMESPACE\", app=~\"$service\"} |~ \"$search\"",
                      "refId": "A"
                    }
                  ],
                  "options": {
                    "showTime": true,
                    "showLabels": true,
                    "showCommonLabels": false,
                    "wrapLogMessage": true,
                    "prettifyLogMessage": true,
                    "enableLogDetails": true,
                    "dedupStrategy": "none",
                    "sortOrder": "Descending"
                  }
                },
                {
                  "id": 2,
                  "title": "Log Rate",
                  "type": "timeseries",
                  "gridPos": {"h": 8, "w": 24, "x": 0, "y": 20},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "sum(count_over_time({namespace=\"APP_NAMESPACE\", app=~\"$service\"}[1m]))",
                      "legendFormat": "Logs/min",
                      "refId": "A"
                    }
                  ]
                }
              ]
            },
            "overwrite": true
          }
          EOF

          sed -i "s/APP_NAMESPACE/$APP_NS/g" /tmp/dashboard-logs.json

          curl -k -X POST \
            -H "Content-Type: application/json" \
            -u "admin:${GRAFANA_PASSWORD}" \
            -d @/tmp/dashboard-logs.json \
            "${GRAFANA_URL}/api/dashboards/db" && echo "‚úÖ Logs dashboard created" || echo "‚ö†Ô∏è Dashboard may already exist"

      - name: Create Error Analysis Dashboard
        run: |
          echo "üìä Creating Error Analysis Dashboard..."

          GRAFANA_URL="${{ steps.grafana.outputs.url }}"
          GRAFANA_PASSWORD="${{ steps.grafana.outputs.password }}"
          APP_NS="${{ github.event.inputs.app_namespace }}"

          cat <<'EOF' > /tmp/dashboard-errors.json
          {
            "dashboard": {
              "id": null,
              "uid": "mortgage-errors",
              "title": "Mortgage Services - Error Analysis",
              "tags": ["mortgage", "errors", "alerts"],
              "timezone": "browser",
              "schemaVersion": 38,
              "version": 1,
              "refresh": "30s",
              "panels": [
                {
                  "id": 1,
                  "title": "Error Count (Last Hour)",
                  "type": "stat",
                  "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "sum(count_over_time({namespace=\"APP_NAMESPACE\"} |~ \"(?i)error|exception\" [1h]))",
                      "refId": "A"
                    }
                  ],
                  "options": {
                    "colorMode": "value",
                    "graphMode": "none",
                    "justifyMode": "auto",
                    "textMode": "value"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {"color": "green", "value": null},
                          {"color": "yellow", "value": 10},
                          {"color": "red", "value": 50}
                        ]
                      }
                    }
                  }
                },
                {
                  "id": 2,
                  "title": "Warning Count (Last Hour)",
                  "type": "stat",
                  "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "sum(count_over_time({namespace=\"APP_NAMESPACE\"} |~ \"(?i)warn\" [1h]))",
                      "refId": "A"
                    }
                  ],
                  "options": {
                    "colorMode": "value",
                    "graphMode": "none"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {"color": "green", "value": null},
                          {"color": "yellow", "value": 50},
                          {"color": "orange", "value": 100}
                        ]
                      }
                    }
                  }
                },
                {
                  "id": 3,
                  "title": "Services with Errors",
                  "type": "stat",
                  "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "count(sum by (app) (count_over_time({namespace=\"APP_NAMESPACE\"} |~ \"(?i)error\" [1h])) > 0)",
                      "refId": "A"
                    }
                  ],
                  "options": {
                    "colorMode": "value",
                    "graphMode": "none"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {"color": "green", "value": null},
                          {"color": "yellow", "value": 1},
                          {"color": "red", "value": 3}
                        ]
                      }
                    }
                  }
                },
                {
                  "id": 4,
                  "title": "Error Trend (24h)",
                  "type": "timeseries",
                  "gridPos": {"h": 8, "w": 24, "x": 0, "y": 4},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "sum by (app) (count_over_time({namespace=\"APP_NAMESPACE\"} |~ \"(?i)error|exception\" [5m]))",
                      "legendFormat": "{{app}}",
                      "refId": "A"
                    }
                  ],
                  "fieldConfig": {
                    "defaults": {
                      "custom": {
                        "drawStyle": "line",
                        "lineWidth": 2,
                        "fillOpacity": 20
                      }
                    }
                  }
                },
                {
                  "id": 5,
                  "title": "Errors by Service",
                  "type": "barchart",
                  "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "sum by (app) (count_over_time({namespace=\"APP_NAMESPACE\"} |~ \"(?i)error|exception\" [1h]))",
                      "legendFormat": "{{app}}",
                      "refId": "A"
                    }
                  ]
                },
                {
                  "id": 6,
                  "title": "Exception Types",
                  "type": "table",
                  "gridPos": {"h": 8, "w": 12, "x": 12, "y": 12},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "{namespace=\"APP_NAMESPACE\"} |~ \"(?i)exception\" | pattern \"<_> <exception>Exception<_>\" | line_format \"{{.exception}}\"",
                      "refId": "A"
                    }
                  ],
                  "transformations": [
                    {
                      "id": "extractFields",
                      "options": {"source": "Line"}
                    }
                  ]
                },
                {
                  "id": 7,
                  "title": "Recent Errors",
                  "type": "logs",
                  "gridPos": {"h": 10, "w": 24, "x": 0, "y": 20},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "{namespace=\"APP_NAMESPACE\"} |~ \"(?i)error|exception|fail\"",
                      "refId": "A"
                    }
                  ],
                  "options": {
                    "showTime": true,
                    "showLabels": true,
                    "wrapLogMessage": true,
                    "enableLogDetails": true,
                    "sortOrder": "Descending"
                  }
                }
              ]
            },
            "overwrite": true
          }
          EOF

          sed -i "s/APP_NAMESPACE/$APP_NS/g" /tmp/dashboard-errors.json

          curl -k -X POST \
            -H "Content-Type: application/json" \
            -u "admin:${GRAFANA_PASSWORD}" \
            -d @/tmp/dashboard-errors.json \
            "${GRAFANA_URL}/api/dashboards/db" && echo "‚úÖ Error Analysis dashboard created" || echo "‚ö†Ô∏è Dashboard may already exist"

      - name: Create Per-Service Dashboard Template
        run: |
          echo "üìä Creating Per-Service Dashboard..."

          GRAFANA_URL="${{ steps.grafana.outputs.url }}"
          GRAFANA_PASSWORD="${{ steps.grafana.outputs.password }}"
          APP_NS="${{ github.event.inputs.app_namespace }}"

          cat <<'EOF' > /tmp/dashboard-service.json
          {
            "dashboard": {
              "id": null,
              "uid": "mortgage-service-detail",
              "title": "Mortgage Services - Service Detail",
              "tags": ["mortgage", "service"],
              "timezone": "browser",
              "schemaVersion": 38,
              "version": 1,
              "refresh": "30s",
              "templating": {
                "list": [
                  {
                    "name": "service",
                    "type": "query",
                    "datasource": {"type": "loki", "uid": "loki"},
                    "query": "label_values({namespace=\"APP_NAMESPACE\"}, app)",
                    "refresh": 1,
                    "current": {"text": "customer-service", "value": "customer-service"}
                  }
                ]
              },
              "panels": [
                {
                  "id": 1,
                  "title": "$service - Log Volume",
                  "type": "timeseries",
                  "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "sum(count_over_time({namespace=\"APP_NAMESPACE\", app=\"$service\"}[1m]))",
                      "legendFormat": "Logs/min",
                      "refId": "A"
                    }
                  ]
                },
                {
                  "id": 2,
                  "title": "$service - Error Rate",
                  "type": "timeseries",
                  "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "sum(count_over_time({namespace=\"APP_NAMESPACE\", app=\"$service\"} |~ \"(?i)error\" [1m]))",
                      "legendFormat": "Errors/min",
                      "refId": "A"
                    }
                  ],
                  "fieldConfig": {
                    "defaults": {
                      "color": {"fixedColor": "red", "mode": "fixed"}
                    }
                  }
                },
                {
                  "id": 3,
                  "title": "$service - Log Levels",
                  "type": "piechart",
                  "gridPos": {"h": 8, "w": 8, "x": 0, "y": 8},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "sum by (level) (count_over_time({namespace=\"APP_NAMESPACE\", app=\"$service\"} | json | level != \"\" [1h]))",
                      "legendFormat": "{{level}}",
                      "refId": "A"
                    }
                  ]
                },
                {
                  "id": 4,
                  "title": "$service - Stats",
                  "type": "stat",
                  "gridPos": {"h": 8, "w": 16, "x": 8, "y": 8},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "sum(count_over_time({namespace=\"APP_NAMESPACE\", app=\"$service\"}[1h]))",
                      "legendFormat": "Total Logs (1h)",
                      "refId": "A"
                    },
                    {
                      "expr": "sum(count_over_time({namespace=\"APP_NAMESPACE\", app=\"$service\"} |~ \"(?i)error\" [1h]))",
                      "legendFormat": "Errors (1h)",
                      "refId": "B"
                    }
                  ],
                  "options": {
                    "reduceOptions": {"calcs": ["lastNotNull"]},
                    "orientation": "horizontal",
                    "textMode": "value_and_name"
                  }
                },
                {
                  "id": 5,
                  "title": "$service - Live Logs",
                  "type": "logs",
                  "gridPos": {"h": 12, "w": 24, "x": 0, "y": 16},
                  "datasource": {"type": "loki", "uid": "loki"},
                  "targets": [
                    {
                      "expr": "{namespace=\"APP_NAMESPACE\", app=\"$service\"}",
                      "refId": "A"
                    }
                  ],
                  "options": {
                    "showTime": true,
                    "showLabels": false,
                    "wrapLogMessage": true,
                    "prettifyLogMessage": true,
                    "enableLogDetails": true,
                    "sortOrder": "Descending"
                  }
                }
              ]
            },
            "overwrite": true
          }
          EOF

          sed -i "s/APP_NAMESPACE/$APP_NS/g" /tmp/dashboard-service.json

          curl -k -X POST \
            -H "Content-Type: application/json" \
            -u "admin:${GRAFANA_PASSWORD}" \
            -d @/tmp/dashboard-service.json \
            "${GRAFANA_URL}/api/dashboards/db" && echo "‚úÖ Service Detail dashboard created" || echo "‚ö†Ô∏è Dashboard may already exist"

      - name: Create Dashboard Folder
        run: |
          echo "üìÅ Creating dashboard folder..."

          GRAFANA_URL="${{ steps.grafana.outputs.url }}"
          GRAFANA_PASSWORD="${{ steps.grafana.outputs.password }}"

          curl -k -X POST \
            -H "Content-Type: application/json" \
            -u "admin:${GRAFANA_PASSWORD}" \
            -d '{"title": "Mortgage Application"}' \
            "${GRAFANA_URL}/api/folders" 2>/dev/null || echo "Folder may already exist"

      - name: List Created Dashboards
        run: |
          echo "üìã Listing dashboards..."

          GRAFANA_URL="${{ steps.grafana.outputs.url }}"
          GRAFANA_PASSWORD="${{ steps.grafana.outputs.password }}"

          curl -k -s -u "admin:${GRAFANA_PASSWORD}" \
            "${GRAFANA_URL}/api/search?type=dash-db" | jq -r '.[] | "\(.title) - \(.url)"'

      - name: Summary
        run: |
          GRAFANA_URL="${{ steps.grafana.outputs.url }}"

          echo "## üéâ Grafana Dashboards Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dashboards" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Dashboard | Description | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Services Overview | High-level view of all services | [Open](${GRAFANA_URL}/d/mortgage-overview) |" >> $GITHUB_STEP_SUMMARY
          echo "| Logs | Live log viewer with filters | [Open](${GRAFANA_URL}/d/mortgage-logs) |" >> $GITHUB_STEP_SUMMARY
          echo "| Error Analysis | Error tracking and trends | [Open](${GRAFANA_URL}/d/mortgage-errors) |" >> $GITHUB_STEP_SUMMARY
          echo "| Service Detail | Per-service deep dive | [Open](${GRAFANA_URL}/d/mortgage-service-detail) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${GRAFANA_URL}" >> $GITHUB_STEP_SUMMARY
          echo "- **Username**: admin" >> $GITHUB_STEP_SUMMARY
