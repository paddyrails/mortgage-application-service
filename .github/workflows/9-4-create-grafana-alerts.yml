name: 9.4 Create Grafana Alerts

# ============================================================
# Creates Grafana alerts for mortgage microservices:
# - High Error Rate Alert
# - Service Down Alert
# - Log Volume Spike Alert
# - No Logs Alert (service may be down)
# - Exception Pattern Alert
#
# Notification channels: Email, Slack, PagerDuty, Webhook
# ============================================================

on:
  workflow_dispatch:
    inputs:
      monitoring_namespace:
        description: "Namespace where Grafana is deployed"
        required: true
        default: "monitoring"
      app_namespace:
        description: "Namespace where microservices are deployed"
        required: true
        default: "mortgage-app"
      slack_webhook_url:
        description: "Slack webhook URL for notifications (optional)"
        required: false
        default: ""
      email_addresses:
        description: "Email addresses for notifications (comma-separated, optional)"
        required: false
        default: ""
      error_threshold:
        description: "Error count threshold per 5 minutes"
        required: true
        default: "10"
      warning_threshold:
        description: "Warning count threshold per 5 minutes"
        required: true
        default: "50"

jobs:
  create-alerts:
    name: Create Grafana Alerts
    runs-on: ubuntu-latest

    steps:
      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify=true

      - name: Get Grafana Credentials
        id: grafana
        run: |
          GRAFANA_URL=$(oc get route grafana -n ${{ github.event.inputs.monitoring_namespace }} -o jsonpath='{.spec.host}')
          GRAFANA_PASSWORD=$(oc get secret grafana-admin-credentials -n ${{ github.event.inputs.monitoring_namespace }} -o jsonpath='{.data.admin-password}' | base64 -d)

          echo "url=https://${GRAFANA_URL}" >> $GITHUB_OUTPUT
          echo "password=${GRAFANA_PASSWORD}" >> $GITHUB_OUTPUT

      - name: Create Alert Contact Points
        run: |
          echo "üìß Creating alert contact points..."

          GRAFANA_URL="${{ steps.grafana.outputs.url }}"
          GRAFANA_PASSWORD="${{ steps.grafana.outputs.password }}"

          # Create Slack contact point if webhook URL provided
          if [ -n "${{ github.event.inputs.slack_webhook_url }}" ]; then
            cat <<EOF > /tmp/slack-contact.json
          {
            "name": "Slack - Mortgage Alerts",
            "type": "slack",
            "settings": {
              "url": "${{ github.event.inputs.slack_webhook_url }}",
              "recipient": "#mortgage-alerts",
              "username": "Grafana Alert",
              "icon_emoji": ":warning:",
              "mentionChannel": "here"
            },
            "disableResolveMessage": false
          }
          EOF
            
            curl -k -X POST \
              -H "Content-Type: application/json" \
              -u "admin:${GRAFANA_PASSWORD}" \
              -d @/tmp/slack-contact.json \
              "${GRAFANA_URL}/api/v1/provisioning/contact-points" 2>/dev/null && echo "‚úÖ Slack contact point created" || echo "‚ö†Ô∏è May already exist"
          fi

          # Create Email contact point if addresses provided
          if [ -n "${{ github.event.inputs.email_addresses }}" ]; then
            cat <<EOF > /tmp/email-contact.json
          {
            "name": "Email - Mortgage Alerts",
            "type": "email",
            "settings": {
              "addresses": "${{ github.event.inputs.email_addresses }}",
              "singleEmail": false
            },
            "disableResolveMessage": false
          }
          EOF
            
            curl -k -X POST \
              -H "Content-Type: application/json" \
              -u "admin:${GRAFANA_PASSWORD}" \
              -d @/tmp/email-contact.json \
              "${GRAFANA_URL}/api/v1/provisioning/contact-points" 2>/dev/null && echo "‚úÖ Email contact point created" || echo "‚ö†Ô∏è May already exist"
          fi

          # Create default webhook contact point
          cat <<EOF > /tmp/webhook-contact.json
          {
            "name": "Webhook - Default",
            "type": "webhook",
            "settings": {
              "url": "http://localhost:9999/webhook",
              "httpMethod": "POST"
            },
            "disableResolveMessage": false
          }
          EOF

      - name: Create Alert Folder
        id: folder
        run: |
          echo "üìÅ Creating alert folder..."

          GRAFANA_URL="${{ steps.grafana.outputs.url }}"
          GRAFANA_PASSWORD="${{ steps.grafana.outputs.password }}"

          FOLDER_RESPONSE=$(curl -k -s -X POST \
            -H "Content-Type: application/json" \
            -u "admin:${GRAFANA_PASSWORD}" \
            -d '{"title": "Mortgage Alerts"}' \
            "${GRAFANA_URL}/api/folders" 2>/dev/null || echo '{"uid":"mortgage-alerts"}')

          FOLDER_UID=$(echo $FOLDER_RESPONSE | jq -r '.uid // "mortgage-alerts"')
          echo "folder_uid=${FOLDER_UID}" >> $GITHUB_OUTPUT
          echo "‚úÖ Alert folder: $FOLDER_UID"

      - name: Create High Error Rate Alert
        run: |
          echo "üö® Creating High Error Rate alert..."

          GRAFANA_URL="${{ steps.grafana.outputs.url }}"
          GRAFANA_PASSWORD="${{ steps.grafana.outputs.password }}"
          APP_NS="${{ github.event.inputs.app_namespace }}"
          ERROR_THRESHOLD="${{ github.event.inputs.error_threshold }}"

          cat <<EOF > /tmp/alert-errors.json
          {
            "folderUid": "${{ steps.folder.outputs.folder_uid }}",
            "ruleGroup": "mortgage-alerts",
            "title": "High Error Rate",
            "condition": "C",
            "data": [
              {
                "refId": "A",
                "queryType": "range",
                "relativeTimeRange": {"from": 300, "to": 0},
                "datasourceUid": "loki",
                "model": {
                  "expr": "sum(count_over_time({namespace=\"${APP_NS}\"} |~ \"(?i)error|exception\" [5m]))",
                  "refId": "A"
                }
              },
              {
                "refId": "B",
                "queryType": "",
                "relativeTimeRange": {"from": 0, "to": 0},
                "datasourceUid": "-100",
                "model": {
                  "conditions": [
                    {
                      "evaluator": {"params": [], "type": "gt"},
                      "operator": {"type": "and"},
                      "query": {"params": ["A"]},
                      "reducer": {"params": [], "type": "last"},
                      "type": "query"
                    }
                  ],
                  "datasource": {"type": "__expr__", "uid": "-100"},
                  "expression": "A",
                  "reducer": "last",
                  "refId": "B",
                  "type": "reduce"
                }
              },
              {
                "refId": "C",
                "queryType": "",
                "relativeTimeRange": {"from": 0, "to": 0},
                "datasourceUid": "-100",
                "model": {
                  "conditions": [
                    {
                      "evaluator": {"params": [${ERROR_THRESHOLD}], "type": "gt"},
                      "operator": {"type": "and"},
                      "query": {"params": ["B"]},
                      "reducer": {"params": [], "type": "last"},
                      "type": "query"
                    }
                  ],
                  "datasource": {"type": "__expr__", "uid": "-100"},
                  "expression": "B",
                  "refId": "C",
                  "type": "threshold"
                }
              }
            ],
            "noDataState": "OK",
            "execErrState": "Error",
            "for": "5m",
            "annotations": {
              "summary": "High error rate detected in mortgage services",
              "description": "More than ${ERROR_THRESHOLD} errors in the last 5 minutes across mortgage services in namespace ${APP_NS}"
            },
            "labels": {
              "severity": "critical",
              "team": "mortgage",
              "namespace": "${APP_NS}"
            },
            "isPaused": false
          }
          EOF

          curl -k -X POST \
            -H "Content-Type: application/json" \
            -u "admin:${GRAFANA_PASSWORD}" \
            -d @/tmp/alert-errors.json \
            "${GRAFANA_URL}/api/v1/provisioning/alert-rules" 2>/dev/null && echo "‚úÖ High Error Rate alert created" || echo "‚ö†Ô∏è Alert may already exist"

      - name: Create Service Error Alert (Per Service)
        run: |
          echo "üö® Creating per-service error alerts..."

          GRAFANA_URL="${{ steps.grafana.outputs.url }}"
          GRAFANA_PASSWORD="${{ steps.grafana.outputs.password }}"
          APP_NS="${{ github.event.inputs.app_namespace }}"

          for SERVICE in customer-service property-service loans-service payments-service application-service; do
            cat <<EOF > /tmp/alert-${SERVICE}.json
          {
            "folderUid": "${{ steps.folder.outputs.folder_uid }}",
            "ruleGroup": "mortgage-service-alerts",
            "title": "${SERVICE} - Errors",
            "condition": "C",
            "data": [
              {
                "refId": "A",
                "queryType": "range",
                "relativeTimeRange": {"from": 300, "to": 0},
                "datasourceUid": "loki",
                "model": {
                  "expr": "sum(count_over_time({namespace=\"${APP_NS}\", app=\"${SERVICE}\"} |~ \"(?i)error|exception\" [5m]))",
                  "refId": "A"
                }
              },
              {
                "refId": "B",
                "datasourceUid": "-100",
                "model": {
                  "expression": "A",
                  "reducer": "last",
                  "refId": "B",
                  "type": "reduce"
                }
              },
              {
                "refId": "C",
                "datasourceUid": "-100",
                "model": {
                  "conditions": [{"evaluator": {"params": [5], "type": "gt"}}],
                  "expression": "B",
                  "refId": "C",
                  "type": "threshold"
                }
              }
            ],
            "noDataState": "OK",
            "execErrState": "Error",
            "for": "5m",
            "annotations": {
              "summary": "Errors detected in ${SERVICE}",
              "description": "More than 5 errors in ${SERVICE} in the last 5 minutes"
            },
            "labels": {
              "severity": "warning",
              "service": "${SERVICE}",
              "team": "mortgage"
            },
            "isPaused": false
          }
          EOF
            
            curl -k -X POST \
              -H "Content-Type: application/json" \
              -u "admin:${GRAFANA_PASSWORD}" \
              -d @/tmp/alert-${SERVICE}.json \
              "${GRAFANA_URL}/api/v1/provisioning/alert-rules" 2>/dev/null && echo "‚úÖ ${SERVICE} alert created" || echo "‚ö†Ô∏è May exist"
          done

      - name: Create No Logs Alert (Service Down)
        run: |
          echo "üö® Creating No Logs alert..."

          GRAFANA_URL="${{ steps.grafana.outputs.url }}"
          GRAFANA_PASSWORD="${{ steps.grafana.outputs.password }}"
          APP_NS="${{ github.event.inputs.app_namespace }}"

          cat <<EOF > /tmp/alert-no-logs.json
          {
            "folderUid": "${{ steps.folder.outputs.folder_uid }}",
            "ruleGroup": "mortgage-health-alerts",
            "title": "No Logs - Service May Be Down",
            "condition": "C",
            "data": [
              {
                "refId": "A",
                "queryType": "range",
                "relativeTimeRange": {"from": 600, "to": 0},
                "datasourceUid": "loki",
                "model": {
                  "expr": "sum(count_over_time({namespace=\"${APP_NS}\"}[10m]))",
                  "refId": "A"
                }
              },
              {
                "refId": "B",
                "datasourceUid": "-100",
                "model": {
                  "expression": "A",
                  "reducer": "last",
                  "refId": "B",
                  "type": "reduce"
                }
              },
              {
                "refId": "C",
                "datasourceUid": "-100",
                "model": {
                  "conditions": [{"evaluator": {"params": [1], "type": "lt"}}],
                  "expression": "B",
                  "refId": "C",
                  "type": "threshold"
                }
              }
            ],
            "noDataState": "Alerting",
            "execErrState": "Alerting",
            "for": "10m",
            "annotations": {
              "summary": "No logs received from mortgage services",
              "description": "No logs have been received from namespace ${APP_NS} in the last 10 minutes. Services may be down."
            },
            "labels": {
              "severity": "critical",
              "team": "mortgage"
            },
            "isPaused": false
          }
          EOF

          curl -k -X POST \
            -H "Content-Type: application/json" \
            -u "admin:${GRAFANA_PASSWORD}" \
            -d @/tmp/alert-no-logs.json \
            "${GRAFANA_URL}/api/v1/provisioning/alert-rules" 2>/dev/null && echo "‚úÖ No Logs alert created" || echo "‚ö†Ô∏è Alert may already exist"

      - name: Create Log Volume Spike Alert
        run: |
          echo "üö® Creating Log Volume Spike alert..."

          GRAFANA_URL="${{ steps.grafana.outputs.url }}"
          GRAFANA_PASSWORD="${{ steps.grafana.outputs.password }}"
          APP_NS="${{ github.event.inputs.app_namespace }}"

          cat <<EOF > /tmp/alert-spike.json
          {
            "folderUid": "${{ steps.folder.outputs.folder_uid }}",
            "ruleGroup": "mortgage-health-alerts",
            "title": "Log Volume Spike",
            "condition": "C",
            "data": [
              {
                "refId": "A",
                "queryType": "range",
                "relativeTimeRange": {"from": 300, "to": 0},
                "datasourceUid": "loki",
                "model": {
                  "expr": "sum(count_over_time({namespace=\"${APP_NS}\"}[5m]))",
                  "refId": "A"
                }
              },
              {
                "refId": "B",
                "datasourceUid": "-100",
                "model": {
                  "expression": "A",
                  "reducer": "last",
                  "refId": "B",
                  "type": "reduce"
                }
              },
              {
                "refId": "C",
                "datasourceUid": "-100",
                "model": {
                  "conditions": [{"evaluator": {"params": [10000], "type": "gt"}}],
                  "expression": "B",
                  "refId": "C",
                  "type": "threshold"
                }
              }
            ],
            "noDataState": "OK",
            "execErrState": "Error",
            "for": "5m",
            "annotations": {
              "summary": "Unusual log volume spike detected",
              "description": "Log volume has spiked above 10,000 logs in 5 minutes. This may indicate a problem."
            },
            "labels": {
              "severity": "warning",
              "team": "mortgage"
            },
            "isPaused": false
          }
          EOF

          curl -k -X POST \
            -H "Content-Type: application/json" \
            -u "admin:${GRAFANA_PASSWORD}" \
            -d @/tmp/alert-spike.json \
            "${GRAFANA_URL}/api/v1/provisioning/alert-rules" 2>/dev/null && echo "‚úÖ Log Volume Spike alert created" || echo "‚ö†Ô∏è Alert may already exist"

      - name: Create Notification Policy
        run: |
          echo "üì¨ Creating notification policy..."

          GRAFANA_URL="${{ steps.grafana.outputs.url }}"
          GRAFANA_PASSWORD="${{ steps.grafana.outputs.password }}"

          # Determine contact point
          CONTACT_POINT="grafana-default-email"
          if [ -n "${{ github.event.inputs.slack_webhook_url }}" ]; then
            CONTACT_POINT="Slack - Mortgage Alerts"
          elif [ -n "${{ github.event.inputs.email_addresses }}" ]; then
            CONTACT_POINT="Email - Mortgage Alerts"
          fi

          cat <<EOF > /tmp/notification-policy.json
          {
            "receiver": "${CONTACT_POINT}",
            "group_by": ["alertname", "service"],
            "routes": [
              {
                "receiver": "${CONTACT_POINT}",
                "matchers": ["team=mortgage"],
                "group_wait": "30s",
                "group_interval": "5m",
                "repeat_interval": "4h"
              }
            ],
            "group_wait": "30s",
            "group_interval": "5m",
            "repeat_interval": "4h"
          }
          EOF

          curl -k -X PUT \
            -H "Content-Type: application/json" \
            -u "admin:${GRAFANA_PASSWORD}" \
            -d @/tmp/notification-policy.json \
            "${GRAFANA_URL}/api/v1/provisioning/policies" 2>/dev/null && echo "‚úÖ Notification policy configured" || echo "‚ö†Ô∏è Policy may need manual configuration"

      - name: List Created Alerts
        run: |
          echo "üìã Listing alerts..."

          GRAFANA_URL="${{ steps.grafana.outputs.url }}"
          GRAFANA_PASSWORD="${{ steps.grafana.outputs.password }}"

          curl -k -s -u "admin:${GRAFANA_PASSWORD}" \
            "${GRAFANA_URL}/api/v1/provisioning/alert-rules" | jq -r '.[] | "\(.title) - \(.labels.severity)"' 2>/dev/null || echo "Could not list alerts"

      - name: Summary
        run: |
          GRAFANA_URL="${{ steps.grafana.outputs.url }}"

          echo "## üéâ Grafana Alerts Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Alerts Configured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Alert | Severity | Condition |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| High Error Rate | Critical | > ${{ github.event.inputs.error_threshold }} errors in 5m |" >> $GITHUB_STEP_SUMMARY
          echo "| No Logs | Critical | No logs for 10m |" >> $GITHUB_STEP_SUMMARY
          echo "| Log Volume Spike | Warning | > 10,000 logs in 5m |" >> $GITHUB_STEP_SUMMARY
          echo "| customer-service Errors | Warning | > 5 errors in 5m |" >> $GITHUB_STEP_SUMMARY
          echo "| property-service Errors | Warning | > 5 errors in 5m |" >> $GITHUB_STEP_SUMMARY
          echo "| loans-service Errors | Warning | > 5 errors in 5m |" >> $GITHUB_STEP_SUMMARY
          echo "| payments-service Errors | Warning | > 5 errors in 5m |" >> $GITHUB_STEP_SUMMARY
          echo "| application-service Errors | Warning | > 5 errors in 5m |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Notification Channels" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.inputs.slack_webhook_url }}" ]; then
            echo "- ‚úÖ Slack configured" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ github.event.inputs.email_addresses }}" ]; then
            echo "- ‚úÖ Email configured: ${{ github.event.inputs.email_addresses }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -z "${{ github.event.inputs.slack_webhook_url }}" ] && [ -z "${{ github.event.inputs.email_addresses }}" ]; then
            echo "- ‚ö†Ô∏è No notification channel configured. Alerts will show in Grafana UI only." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### View Alerts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Alert Rules](${GRAFANA_URL}/alerting/list)" >> $GITHUB_STEP_SUMMARY
          echo "- [Alert History](${GRAFANA_URL}/alerting/history)" >> $GITHUB_STEP_SUMMARY
          echo "- [Notification Policies](${GRAFANA_URL}/alerting/routes)" >> $GITHUB_STEP_SUMMARY
