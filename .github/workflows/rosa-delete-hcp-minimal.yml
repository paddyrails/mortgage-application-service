name: Delete ROSA HCP Minimal Cluster

# ============================================================
# Deletes ROSA HCP cluster and cleans up all AWS resources:
# - ROSA Cluster
# - VPC, Subnets, Route Tables
# - NAT Gateway, Internet Gateway
# - Elastic IP
# - OIDC Provider, Operator Roles
# ============================================================

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: 'Cluster name to delete'
        required: true
        default: 'mortgage-test'
      confirm_cluster_name:
        description: 'Type cluster name again to confirm'
        required: true
      delete_vpc:
        description: 'Also delete VPC and networking resources'
        required: true
        default: true
        type: boolean
      delete_oidc:
        description: 'Also delete OIDC provider and operator roles'
        required: true
        default: true
        type: boolean

env:
  AWS_REGION: us-east-1

jobs:
  delete-cluster:
    name: Delete ROSA HCP Cluster
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          echo "๐ Validating deletion confirmation..."
          
          if [ "${{ github.event.inputs.cluster_name }}" != "${{ github.event.inputs.confirm_cluster_name }}" ]; then
            echo ""
            echo "โ CONFIRMATION FAILED!"
            echo ""
            echo "   Cluster name entered: ${{ github.event.inputs.cluster_name }}"
            echo "   Confirmation entered: ${{ github.event.inputs.confirm_cluster_name }}"
            echo ""
            echo "   These must match exactly to proceed."
            exit 1
          fi
          
          echo "โ Deletion confirmed for: ${{ github.event.inputs.cluster_name }}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install ROSA CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/rosa/latest/rosa-linux.tar.gz
          tar -xvf rosa-linux.tar.gz
          sudo mv rosa /usr/local/bin/
          rosa version

      - name: Login to ROSA
        run: |
          rosa login --token=${{ secrets.ROSA_TOKEN }}
          rosa whoami

      - name: Check cluster exists
        id: check
        run: |
          echo "๐ Checking if cluster exists..."
          
          if rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo ""
            echo "๐ Cluster details:"
            rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }}
            echo ""
            echo "๐ฅ๏ธ Machine pools:"
            rosa list machinepools --cluster=${{ github.event.inputs.cluster_name }} 2>/dev/null || true
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "โ๏ธ Cluster '${{ github.event.inputs.cluster_name }}' not found"
            echo ""
            echo "Available clusters:"
            rosa list clusters
          fi

      - name: Delete ROSA cluster
        if: steps.check.outputs.exists == 'true'
        run: |
          echo "๐๏ธ Deleting ROSA HCP cluster: ${{ github.event.inputs.cluster_name }}"
          echo ""
          echo "โ๏ธ  THIS ACTION IS IRREVERSIBLE!"
          echo ""
          
          rosa delete cluster \
            --cluster=${{ github.event.inputs.cluster_name }} \
            --yes
          
          echo ""
          echo "โ Cluster deletion initiated"

      - name: Wait for cluster deletion
        if: steps.check.outputs.exists == 'true'
        run: |
          echo "โณ Waiting for cluster deletion..."
          echo "   This typically takes 5-15 minutes for HCP clusters."
          echo ""
          
          TIMEOUT=1200  # 20 minutes
          INTERVAL=30
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if ! rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} &>/dev/null; then
              echo ""
              echo "โ Cluster deleted successfully!"
              break
            fi
            
            STATUS=$(rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} -o json 2>/dev/null | jq -r '.status.state' || echo "deleting")
            echo "$(date '+%H:%M:%S') - Status: ${STATUS}"
            
            if [ "$STATUS" == "error" ]; then
              echo "โ Error during deletion"
              rosa logs uninstall --cluster=${{ github.event.inputs.cluster_name }} --tail=50 || true
              break
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

      - name: Delete OIDC provider and operator roles
        if: github.event.inputs.delete_oidc == 'true'
        run: |
          echo "๐งน Cleaning up OIDC provider and operator roles..."
          
          # Delete operator roles
          echo "Deleting operator roles..."
          rosa delete operator-roles \
            --cluster=${{ github.event.inputs.cluster_name }} \
            --mode=auto \
            --yes 2>/dev/null || echo "Operator roles may not exist or already deleted"
          
          # Delete OIDC provider
          echo "Deleting OIDC provider..."
          rosa delete oidc-provider \
            --cluster=${{ github.event.inputs.cluster_name }} \
            --mode=auto \
            --yes 2>/dev/null || echo "OIDC provider may not exist or already deleted"
          
          echo "โ OIDC cleanup complete"

      - name: Delete VPC and networking resources
        if: github.event.inputs.delete_vpc == 'true'
        run: |
          echo "๐ Cleaning up VPC and networking resources..."
          echo "   (VPC has 2 public + 2 private subnets in different AZs)"
          
          CLUSTER_NAME="${{ github.event.inputs.cluster_name }}"
          
          # Find VPC
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values=${CLUSTER_NAME}-vpc" \
            --query 'Vpcs[0].VpcId' --output text 2>/dev/null || echo "None")
          
          if [ "$VPC_ID" == "None" ] || [ -z "$VPC_ID" ]; then
            echo "No VPC found with name ${CLUSTER_NAME}-vpc"
            echo "Skipping VPC cleanup"
            exit 0
          fi
          
          echo "Found VPC: $VPC_ID"
          
          # =====================
          # Delete NAT Gateways
          # =====================
          echo ""
          echo "๐๏ธ Deleting NAT Gateways..."
          NAT_GWS=$(aws ec2 describe-nat-gateways \
            --filter "Name=vpc-id,Values=$VPC_ID" "Name=state,Values=available,pending,deleting" \
            --query 'NatGateways[*].NatGatewayId' --output text 2>/dev/null || echo "")
          
          for NAT_GW in $NAT_GWS; do
            echo "  Deleting NAT Gateway: $NAT_GW"
            aws ec2 delete-nat-gateway --nat-gateway-id $NAT_GW 2>/dev/null || true
          done
          
          # Wait for NAT Gateways to fully delete
          if [ -n "$NAT_GWS" ] && [ "$NAT_GWS" != "None" ]; then
            echo "  โณ Waiting for NAT Gateways to delete (this may take 1-2 minutes)..."
            for i in {1..24}; do
              REMAINING=$(aws ec2 describe-nat-gateways \
                --filter "Name=vpc-id,Values=$VPC_ID" "Name=state,Values=available,pending,deleting" \
                --query 'NatGateways[*].NatGatewayId' --output text 2>/dev/null || echo "")
              if [ -z "$REMAINING" ] || [ "$REMAINING" == "None" ]; then
                echo "  โ NAT Gateways deleted"
                break
              fi
              sleep 5
            done
          fi
          
          # =====================
          # Release Elastic IPs
          # =====================
          echo ""
          echo "๐๏ธ Releasing Elastic IPs..."
          # Find EIPs by tag
          EIPS=$(aws ec2 describe-addresses \
            --filters "Name=tag:Name,Values=${CLUSTER_NAME}*" \
            --query 'Addresses[*].AllocationId' --output text 2>/dev/null || echo "")
          
          for EIP in $EIPS; do
            if [ -n "$EIP" ] && [ "$EIP" != "None" ]; then
              echo "  Releasing EIP: $EIP"
              aws ec2 release-address --allocation-id $EIP 2>/dev/null || true
            fi
          done
          
          # Also release unassociated EIPs
          UNASSOC_EIPS=$(aws ec2 describe-addresses \
            --filters "Name=domain,Values=vpc" \
            --query 'Addresses[?AssociationId==`null`].AllocationId' --output text 2>/dev/null || echo "")
          
          for EIP in $UNASSOC_EIPS; do
            if [ -n "$EIP" ] && [ "$EIP" != "None" ]; then
              echo "  Releasing unassociated EIP: $EIP"
              aws ec2 release-address --allocation-id $EIP 2>/dev/null || true
            fi
          done
          
          # =====================
          # Delete Subnets (all 4: 2 public + 2 private)
          # =====================
          echo ""
          echo "๐๏ธ Deleting Subnets (4 total)..."
          SUBNETS=$(aws ec2 describe-subnets \
            --filters "Name=vpc-id,Values=$VPC_ID" \
            --query 'Subnets[*].SubnetId' --output text 2>/dev/null || echo "")
          
          for SUBNET in $SUBNETS; do
            if [ -n "$SUBNET" ] && [ "$SUBNET" != "None" ]; then
              SUBNET_NAME=$(aws ec2 describe-subnets --subnet-ids $SUBNET \
                --query 'Subnets[0].Tags[?Key==`Name`].Value' --output text 2>/dev/null || echo "unknown")
              echo "  Deleting Subnet: $SUBNET ($SUBNET_NAME)"
              aws ec2 delete-subnet --subnet-id $SUBNET 2>/dev/null || true
            fi
          done
          
          # =====================
          # Delete Route Tables
          # =====================
          echo ""
          echo "๐๏ธ Deleting Route Tables..."
          RTBS=$(aws ec2 describe-route-tables \
            --filters "Name=vpc-id,Values=$VPC_ID" \
            --query 'RouteTables[?Associations[0].Main!=`true`].RouteTableId' --output text 2>/dev/null || echo "")
          
          for RTB in $RTBS; do
            if [ -n "$RTB" ] && [ "$RTB" != "None" ]; then
              # Disassociate all associations first
              ASSOCS=$(aws ec2 describe-route-tables \
                --route-table-ids $RTB \
                --query 'RouteTables[0].Associations[?!Main].RouteTableAssociationId' --output text 2>/dev/null || echo "")
              
              for ASSOC in $ASSOCS; do
                if [ -n "$ASSOC" ] && [ "$ASSOC" != "None" ]; then
                  aws ec2 disassociate-route-table --association-id $ASSOC 2>/dev/null || true
                fi
              done
              
              echo "  Deleting Route Table: $RTB"
              aws ec2 delete-route-table --route-table-id $RTB 2>/dev/null || true
            fi
          done
          
          # =====================
          # Delete Internet Gateway
          # =====================
          echo ""
          echo "๐๏ธ Deleting Internet Gateway..."
          IGW_ID=$(aws ec2 describe-internet-gateways \
            --filters "Name=attachment.vpc-id,Values=$VPC_ID" \
            --query 'InternetGateways[0].InternetGatewayId' --output text 2>/dev/null || echo "None")
          
          if [ "$IGW_ID" != "None" ] && [ -n "$IGW_ID" ]; then
            echo "  Detaching IGW: $IGW_ID"
            aws ec2 detach-internet-gateway --internet-gateway-id $IGW_ID --vpc-id $VPC_ID 2>/dev/null || true
            echo "  Deleting IGW: $IGW_ID"
            aws ec2 delete-internet-gateway --internet-gateway-id $IGW_ID 2>/dev/null || true
          fi
          
          # =====================
          # Delete Security Groups
          # =====================
          echo ""
          echo "๐๏ธ Deleting Security Groups..."
          SGS=$(aws ec2 describe-security-groups \
            --filters "Name=vpc-id,Values=$VPC_ID" \
            --query 'SecurityGroups[?GroupName!=`default`].GroupId' --output text 2>/dev/null || echo "")
          
          for SG in $SGS; do
            if [ -n "$SG" ] && [ "$SG" != "None" ]; then
              echo "  Deleting Security Group: $SG"
              aws ec2 delete-security-group --group-id $SG 2>/dev/null || true
            fi
          done
          
          # =====================
          # Delete VPC
          # =====================
          echo ""
          echo "๐๏ธ Deleting VPC: $VPC_ID"
          aws ec2 delete-vpc --vpc-id $VPC_ID 2>/dev/null || echo "โ๏ธ VPC deletion may require manual cleanup"
          
          echo ""
          echo "โ VPC and networking cleanup complete"

      - name: Verify cleanup
        run: |
          echo "๐ Verifying cleanup..."
          echo ""
          
          # Check cluster
          if rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} &>/dev/null; then
            echo "โ๏ธ Cluster may still be deleting"
          else
            echo "โ Cluster deleted"
          fi
          
          # Check VPC
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values=${{ github.event.inputs.cluster_name }}-vpc" \
            --query 'Vpcs[0].VpcId' --output text 2>/dev/null || echo "None")
          
          if [ "$VPC_ID" == "None" ] || [ -z "$VPC_ID" ]; then
            echo "โ VPC deleted"
          else
            echo "โ๏ธ VPC still exists: $VPC_ID (may need manual cleanup)"
          fi
          
          echo ""
          echo "๐ Remaining ROSA clusters:"
          rosa list clusters || echo "No clusters found"

      - name: Summary
        run: |
          echo "## ๐๏ธ ROSA HCP Cluster Deletion Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cluster Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster Name | \`${{ github.event.inputs.cluster_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | \`${{ env.AWS_REGION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources Cleaned Up" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ROSA HCP Cluster | โ Deleted |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker Node | โ Terminated |" >> $GITHUB_STEP_SUMMARY
          echo "| Machine Pools | โ Deleted |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.delete_oidc }}" == "true" ]; then
            echo "| OIDC Provider | โ Deleted |" >> $GITHUB_STEP_SUMMARY
            echo "| Operator Roles | โ Deleted |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.event.inputs.delete_vpc }}" == "true" ]; then
            echo "| VPC | โ Deleted |" >> $GITHUB_STEP_SUMMARY
            echo "| Public Subnets (2) | โ Deleted |" >> $GITHUB_STEP_SUMMARY
            echo "| Private Subnets (2) | โ Deleted |" >> $GITHUB_STEP_SUMMARY
            echo "| NAT Gateway | โ Deleted |" >> $GITHUB_STEP_SUMMARY
            echo "| Internet Gateway | โ Deleted |" >> $GITHUB_STEP_SUMMARY
            echo "| Elastic IP | โ Released |" >> $GITHUB_STEP_SUMMARY
            echo "| Route Tables | โ Deleted |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ฐ Cost Savings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "By deleting this cluster, you save:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Period | Savings |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Per Hour | ~\$0.16 |" >> $GITHUB_STEP_SUMMARY
          echo "| Per Day | ~\$3.90 |" >> $GITHUB_STEP_SUMMARY
          echo "| Per Month | ~\$117 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To create a new cluster, run the **Create ROSA HCP Minimal Cluster** workflow." >> $GITHUB_STEP_SUMMARY

      - name: Final output
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "  โ ROSA HCP CLUSTER DELETION COMPLETE"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "  Cluster: ${{ github.event.inputs.cluster_name }}"
          echo ""
          echo "  Resources deleted:"
          echo "    โ ROSA HCP Cluster"
          echo "    โ Worker Nodes"
          if [ "${{ github.event.inputs.delete_oidc }}" == "true" ]; then
            echo "    โ OIDC Provider & Operator Roles"
          fi
          if [ "${{ github.event.inputs.delete_vpc }}" == "true" ]; then
            echo "    โ VPC & Networking (NAT GW, IGW, Subnets)"
          fi
          echo ""
          echo "  Monthly savings: ~\$117"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
