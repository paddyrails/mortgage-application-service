name: 9.1 Deploy Grafana Stack

# ============================================================
# Deploys Grafana + Loki + Promtail on OpenShift
# Uses anyuid SCC for Loki/Grafana compatibility
# ============================================================

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: "Namespace for Grafana stack"
        required: true
        default: "monitoring"
      grafana_admin_password:
        description: "Grafana admin password (leave empty for auto-generated)"
        required: false
        default: ""
      storage_size:
        description: "Storage size for Loki"
        required: true
        default: "10Gi"
        type: choice
        options:
          - "5Gi"
          - "10Gi"
          - "20Gi"

env:
  APP_NAMESPACE: mortgage-app

jobs:
  deploy-grafana-stack:
    name: Deploy Grafana Stack
    runs-on: ubuntu-latest

    steps:
      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/
          oc version --client

      - name: Login to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify=true

          echo "âœ… Logged in to OpenShift"
          oc whoami

      - name: Create Namespace and Grant SCCs
        run: |
          echo "ğŸ“ Creating namespace ${{ github.event.inputs.namespace }}..."

          oc create namespace ${{ github.event.inputs.namespace }} 2>/dev/null || echo "Namespace already exists"
          oc project ${{ github.event.inputs.namespace }}

          echo "ğŸ” Granting Security Context Constraints..."

          # Create service accounts first
          oc create serviceaccount loki -n ${{ github.event.inputs.namespace }} 2>/dev/null || true
          oc create serviceaccount grafana -n ${{ github.event.inputs.namespace }} 2>/dev/null || true
          oc create serviceaccount promtail -n ${{ github.event.inputs.namespace }} 2>/dev/null || true

          # Grant anyuid to loki and grafana (they need to run as specific users)
          oc adm policy add-scc-to-user anyuid -z loki -n ${{ github.event.inputs.namespace }} || echo "May need admin for SCC"
          oc adm policy add-scc-to-user anyuid -z grafana -n ${{ github.event.inputs.namespace }} || echo "May need admin for SCC"

          # Grant privileged to promtail (needs to read host logs)
          oc adm policy add-scc-to-user privileged -z promtail -n ${{ github.event.inputs.namespace }} || echo "May need admin for SCC"

          echo "âœ… SCCs granted"

      - name: Generate Grafana Password
        id: password
        run: |
          if [ -n "${{ github.event.inputs.grafana_admin_password }}" ]; then
            GRAFANA_PASSWORD="${{ github.event.inputs.grafana_admin_password }}"
          else
            GRAFANA_PASSWORD=$(openssl rand -base64 12 | tr -d '/+=' | head -c 12)
          fi
          echo "password=$GRAFANA_PASSWORD" >> $GITHUB_OUTPUT
          echo "âœ… Password generated"

      - name: Deploy Loki
        run: |
          echo "ğŸ“¦ Deploying Loki..."

          cat <<'YAML' | oc apply -n ${{ github.event.inputs.namespace }} -f -
          ---
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: loki-config
            labels:
              app: loki
          data:
            loki.yaml: |
              auth_enabled: false
              server:
                http_listen_port: 3100
                grpc_listen_port: 9096
              common:
                path_prefix: /loki
                storage:
                  filesystem:
                    chunks_directory: /loki/chunks
                    rules_directory: /loki/rules
                replication_factor: 1
                ring:
                  kvstore:
                    store: inmemory
              schema_config:
                configs:
                  - from: 2020-01-01
                    store: boltdb-shipper
                    object_store: filesystem
                    schema: v11
                    index:
                      prefix: index_
                      period: 24h
              storage_config:
                boltdb_shipper:
                  active_index_directory: /loki/index
                  cache_location: /loki/cache
                  shared_store: filesystem
                filesystem:
                  directory: /loki/chunks
              limits_config:
                enforce_metric_name: false
                reject_old_samples: false
              analytics:
                reporting_enabled: false
          YAML

          echo "âœ… Loki ConfigMap created"

          cat <<YAML | oc apply -n ${{ github.event.inputs.namespace }} -f -
          ---
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: loki-data
            labels:
              app: loki
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: ${{ github.event.inputs.storage_size }}
          YAML

          echo "âœ… Loki PVC created"

          cat <<'YAML' | oc apply -n ${{ github.event.inputs.namespace }} -f -
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: loki
            labels:
              app: loki
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: loki
            template:
              metadata:
                labels:
                  app: loki
              spec:
                serviceAccountName: loki
                securityContext:
                  fsGroup: 10001
                containers:
                  - name: loki
                    image: grafana/loki:2.9.4
                    args:
                      - -config.file=/etc/loki/loki.yaml
                    ports:
                      - containerPort: 3100
                        name: http
                    securityContext:
                      runAsUser: 10001
                      runAsGroup: 10001
                    resources:
                      requests:
                        cpu: 100m
                        memory: 256Mi
                      limits:
                        cpu: 500m
                        memory: 512Mi
                    volumeMounts:
                      - name: config
                        mountPath: /etc/loki
                      - name: data
                        mountPath: /loki
                    readinessProbe:
                      httpGet:
                        path: /ready
                        port: 3100
                      initialDelaySeconds: 15
                      periodSeconds: 10
                    livenessProbe:
                      httpGet:
                        path: /ready
                        port: 3100
                      initialDelaySeconds: 30
                      periodSeconds: 10
                volumes:
                  - name: config
                    configMap:
                      name: loki-config
                  - name: data
                    persistentVolumeClaim:
                      claimName: loki-data
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: loki
            labels:
              app: loki
          spec:
            ports:
              - port: 3100
                targetPort: 3100
                name: http
            selector:
              app: loki
          YAML

          echo "âœ… Loki Deployment and Service created"

      - name: Wait for Loki
        run: |
          echo "â³ Waiting for Loki to start..."

          for i in {1..30}; do
            STATUS=$(oc get pods -n ${{ github.event.inputs.namespace }} -l app=loki -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "Pending")
            echo "  Attempt $i: Loki status = $STATUS"
            
            if [ "$STATUS" = "Running" ]; then
              echo "âœ… Loki is running"
              break
            fi
            
            # Check for errors
            if [ "$STATUS" = "Error" ] || [ "$STATUS" = "CrashLoopBackOff" ]; then
              echo "âŒ Loki failed to start. Checking logs..."
              oc logs -n ${{ github.event.inputs.namespace }} -l app=loki --tail=50 || true
              oc describe pod -n ${{ github.event.inputs.namespace }} -l app=loki | tail -30 || true
            fi
            
            sleep 10
          done

          oc get pods -n ${{ github.event.inputs.namespace }} -l app=loki

      - name: Deploy Promtail
        run: |
          echo "ğŸ“¦ Deploying Promtail..."

          cat <<'YAML' | oc apply -n ${{ github.event.inputs.namespace }} -f -
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: promtail
          rules:
            - apiGroups: [""]
              resources: ["nodes", "nodes/proxy", "services", "endpoints", "pods"]
              verbs: ["get", "watch", "list"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: promtail
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: promtail
          subjects:
            - kind: ServiceAccount
              name: promtail
              namespace: NAMESPACE_PLACEHOLDER
          YAML

          # Fix namespace in ClusterRoleBinding
          oc patch clusterrolebinding promtail --type='json' \
            -p='[{"op": "replace", "path": "/subjects/0/namespace", "value": "${{ github.event.inputs.namespace }}"}]' || true

          echo "âœ… Promtail RBAC created"

          cat <<YAML | oc apply -n ${{ github.event.inputs.namespace }} -f -
          ---
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: promtail-config
            labels:
              app: promtail
          data:
            promtail.yaml: |
              server:
                http_listen_port: 9080
                grpc_listen_port: 0
              positions:
                filename: /tmp/positions.yaml
              clients:
                - url: http://loki.${{ github.event.inputs.namespace }}.svc.cluster.local:3100/loki/api/v1/push
              scrape_configs:
                - job_name: pods
                  kubernetes_sd_configs:
                    - role: pod
                  pipeline_stages:
                    - cri: {}
                  relabel_configs:
                    - source_labels: [__meta_kubernetes_namespace]
                      target_label: namespace
                    - source_labels: [__meta_kubernetes_pod_name]
                      target_label: pod
                    - source_labels: [__meta_kubernetes_pod_container_name]
                      target_label: container
                    - source_labels: [__meta_kubernetes_pod_label_app]
                      target_label: app
                    - replacement: /var/log/pods/*\\\$1/*.log
                      separator: /
                      source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
                      target_label: __path__
          YAML

          echo "âœ… Promtail ConfigMap created"

          cat <<'YAML' | oc apply -n ${{ github.event.inputs.namespace }} -f -
          ---
          apiVersion: apps/v1
          kind: DaemonSet
          metadata:
            name: promtail
            labels:
              app: promtail
          spec:
            selector:
              matchLabels:
                app: promtail
            template:
              metadata:
                labels:
                  app: promtail
              spec:
                serviceAccountName: promtail
                containers:
                  - name: promtail
                    image: grafana/promtail:2.9.4
                    args:
                      - -config.file=/etc/promtail/promtail.yaml
                    securityContext:
                      privileged: true
                      runAsUser: 0
                    resources:
                      requests:
                        cpu: 50m
                        memory: 64Mi
                      limits:
                        cpu: 200m
                        memory: 128Mi
                    volumeMounts:
                      - name: config
                        mountPath: /etc/promtail
                      - name: varlog
                        mountPath: /var/log
                        readOnly: true
                      - name: pods
                        mountPath: /var/log/pods
                        readOnly: true
                tolerations:
                  - operator: Exists
                volumes:
                  - name: config
                    configMap:
                      name: promtail-config
                  - name: varlog
                    hostPath:
                      path: /var/log
                  - name: pods
                    hostPath:
                      path: /var/log/pods
          YAML

          echo "âœ… Promtail DaemonSet created"

      - name: Deploy Grafana
        run: |
          echo "ğŸ“¦ Deploying Grafana..."

          # Create Grafana secret
          oc create secret generic grafana-admin \
            --from-literal=admin-user=admin \
            --from-literal=admin-password="${{ steps.password.outputs.password }}" \
            -n ${{ github.event.inputs.namespace }} \
            --dry-run=client -o yaml | oc apply -f -

          echo "âœ… Grafana secret created"

          cat <<'YAML' | oc apply -n ${{ github.event.inputs.namespace }} -f -
          ---
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-datasources
            labels:
              app: grafana
          data:
            datasources.yaml: |
              apiVersion: 1
              datasources:
                - name: Loki
                  type: loki
                  access: proxy
                  url: http://loki:3100
                  isDefault: true
          ---
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: grafana-data
            labels:
              app: grafana
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: grafana
            labels:
              app: grafana
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: grafana
            template:
              metadata:
                labels:
                  app: grafana
              spec:
                serviceAccountName: grafana
                securityContext:
                  fsGroup: 472
                containers:
                  - name: grafana
                    image: grafana/grafana:10.2.3
                    ports:
                      - containerPort: 3000
                        name: http
                    securityContext:
                      runAsUser: 472
                      runAsGroup: 472
                    env:
                      - name: GF_SECURITY_ADMIN_USER
                        valueFrom:
                          secretKeyRef:
                            name: grafana-admin
                            key: admin-user
                      - name: GF_SECURITY_ADMIN_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: grafana-admin
                            key: admin-password
                      - name: GF_PATHS_PROVISIONING
                        value: /etc/grafana/provisioning
                    resources:
                      requests:
                        cpu: 100m
                        memory: 128Mi
                      limits:
                        cpu: 500m
                        memory: 512Mi
                    volumeMounts:
                      - name: data
                        mountPath: /var/lib/grafana
                      - name: datasources
                        mountPath: /etc/grafana/provisioning/datasources
                    readinessProbe:
                      httpGet:
                        path: /api/health
                        port: 3000
                      initialDelaySeconds: 10
                      periodSeconds: 5
                volumes:
                  - name: data
                    persistentVolumeClaim:
                      claimName: grafana-data
                  - name: datasources
                    configMap:
                      name: grafana-datasources
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: grafana
            labels:
              app: grafana
          spec:
            ports:
              - port: 3000
                targetPort: 3000
                name: http
            selector:
              app: grafana
          YAML

          echo "âœ… Grafana Deployment and Service created"

      - name: Create Grafana Route
        id: route
        run: |
          echo "ğŸŒ Creating Grafana route..."

          cat <<'YAML' | oc apply -n ${{ github.event.inputs.namespace }} -f -
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: grafana
            labels:
              app: grafana
          spec:
            to:
              kind: Service
              name: grafana
            port:
              targetPort: 3000
            tls:
              termination: edge
              insecureEdgeTerminationPolicy: Redirect
          YAML

          sleep 5
          GRAFANA_URL=$(oc get route grafana -n ${{ github.event.inputs.namespace }} -o jsonpath='{.spec.host}')
          echo "url=https://${GRAFANA_URL}" >> $GITHUB_OUTPUT
          echo "âœ… Grafana route: https://${GRAFANA_URL}"

      - name: Wait for All Pods
        run: |
          echo "â³ Waiting for all pods to be ready..."

          echo ""
          echo "Waiting for Loki..."
          oc rollout status deployment/loki -n ${{ github.event.inputs.namespace }} --timeout=180s || {
            echo "âš ï¸ Loki rollout issue. Checking events..."
            oc describe deployment loki -n ${{ github.event.inputs.namespace }} | tail -20
          }

          echo ""
          echo "Waiting for Grafana..."
          oc rollout status deployment/grafana -n ${{ github.event.inputs.namespace }} --timeout=180s || {
            echo "âš ï¸ Grafana rollout issue. Checking events..."
            oc describe deployment grafana -n ${{ github.event.inputs.namespace }} | tail -20
          }

          echo ""
          echo "Waiting for Promtail..."
          sleep 10
          oc get pods -n ${{ github.event.inputs.namespace }} -l app=promtail

      - name: Verify Deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          echo ""

          echo "=== Pods ==="
          oc get pods -n ${{ github.event.inputs.namespace }}

          echo ""
          echo "=== Services ==="
          oc get svc -n ${{ github.event.inputs.namespace }}

          echo ""
          echo "=== Routes ==="
          oc get routes -n ${{ github.event.inputs.namespace }}

          echo ""
          echo "=== PVCs ==="
          oc get pvc -n ${{ github.event.inputs.namespace }}

          # Check for any pod issues
          echo ""
          echo "=== Pod Details ==="
          for POD in $(oc get pods -n ${{ github.event.inputs.namespace }} -o name); do
            echo "--- $POD ---"
            oc get $POD -n ${{ github.event.inputs.namespace }} -o jsonpath='{.status.phase}'
            echo ""
          done

          echo ""
          echo "=== Recent Events ==="
          oc get events -n ${{ github.event.inputs.namespace }} --sort-by='.lastTimestamp' | tail -15

      - name: Test Loki Connection
        run: |
          echo "ğŸ§ª Testing Loki..."

          LOKI_POD=$(oc get pod -n ${{ github.event.inputs.namespace }} -l app=loki -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")

          if [ -n "$LOKI_POD" ]; then
            echo "Loki pod: $LOKI_POD"
            echo ""
            echo "Checking Loki readiness..."
            oc exec -n ${{ github.event.inputs.namespace }} $LOKI_POD -- wget -qO- http://localhost:3100/ready 2>/dev/null && echo "âœ… Loki is ready" || echo "âš ï¸ Loki not ready yet"
          else
            echo "âš ï¸ Loki pod not found. Checking pod status..."
            oc get pods -n ${{ github.event.inputs.namespace }} -l app=loki
            oc describe pods -n ${{ github.event.inputs.namespace }} -l app=loki | tail -30
          fi

      - name: Summary
        run: |
          echo "## ğŸ‰ Grafana Stack Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access Grafana" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ steps.route.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Username | \`admin\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Password | \`${{ steps.password.outputs.password }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Components" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Purpose |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Grafana | Dashboards & Visualization |" >> $GITHUB_STEP_SUMMARY
          echo "| Loki | Log Aggregation |" >> $GITHUB_STEP_SUMMARY
          echo "| Promtail | Log Collection |" >> $GITHUB_STEP_SUMMARY

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  GRAFANA STACK DEPLOYMENT COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  URL:      ${{ steps.route.outputs.url }}"
          echo "  Username: admin"
          echo "  Password: ${{ steps.password.outputs.password }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
