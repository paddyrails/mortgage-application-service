name: Delete ROSA Cluster

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: "Cluster name to delete"
        required: true
      confirm_delete:
        description: "Type cluster name again to confirm deletion"
        required: true

env:
  AWS_REGION: us-east-1

jobs:
  delete-cluster:
    name: Delete ROSA Cluster
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.cluster_name }}" != "${{ github.event.inputs.confirm_delete }}" ]; then
            echo "âŒ Confirmation failed!"
            echo "Cluster name: ${{ github.event.inputs.cluster_name }}"
            echo "Confirmation: ${{ github.event.inputs.confirm_delete }}"
            exit 1
          fi
          echo "âœ… Deletion confirmed for cluster: ${{ github.event.inputs.cluster_name }}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install ROSA CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/rosa/latest/rosa-linux.tar.gz
          tar -xvf rosa-linux.tar.gz
          sudo mv rosa /usr/local/bin/

      - name: Login to ROSA
        run: rosa login --token=${{ secrets.ROSA_TOKEN }}

      - name: Check cluster exists
        run: |
          if ! rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} &>/dev/null; then
            echo "âŒ Cluster ${{ github.event.inputs.cluster_name }} not found!"
            exit 1
          fi
          echo "ðŸ“‹ Cluster details before deletion:"
          rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }}

      - name: Delete cluster
        run: |
          echo "ðŸ—‘ï¸ Deleting cluster ${{ github.event.inputs.cluster_name }}..."
          rosa delete cluster --cluster=${{ github.event.inputs.cluster_name }} --yes

          echo "â³ Waiting for cluster deletion to complete..."
          # Poll for deletion (up to 30 minutes)
          for i in {1..30}; do
            if ! rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} &>/dev/null; then
              echo "âœ… Cluster deleted successfully!"
              break
            fi
            echo "$(date): Cluster still deleting..."
            sleep 60
          done

      - name: Cleanup operator roles
        run: |
          echo "ðŸ§¹ Cleaning up operator roles..."
          rosa delete operator-roles --cluster=${{ github.event.inputs.cluster_name }} --yes || true

      - name: Cleanup OIDC provider
        run: |
          echo "ðŸ§¹ Cleaning up OIDC provider..."
          rosa delete oidc-provider --cluster=${{ github.event.inputs.cluster_name }} --yes || true

      - name: Summary
        run: |
          echo "## ðŸ—‘ï¸ ROSA Cluster Deleted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cluster **${{ github.event.inputs.cluster_name }}** has been deleted." >> $GITHUB_STEP_SUMMARY
