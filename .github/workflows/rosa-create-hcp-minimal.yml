name: Create ROSA HCP Minimal Cluster (1 Worker)

# ============================================================
# ROSA with Hosted Control Plane (HCP) - Minimal Configuration
# 
# This is the CHEAPEST OpenShift cluster on AWS:
# - Hosted Control Plane: ~$30/month (vs $500 for classic)
# - 1 Worker Node (Spot): ~$45/month
# - Total: ~$75-100/month
# ============================================================

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: 'Cluster name'
        required: true
        default: 'mortgage-test'
      instance_type:
        description: 'Worker instance type'
        required: true
        default: 'm5.xlarge'
        type: choice
        options:
          - 'm5.large'      # 2 vCPU, 8GB  - ~$70/mo on-demand
          - 'm5.xlarge'     # 4 vCPU, 16GB - ~$140/mo on-demand
          - 'm5.2xlarge'    # 8 vCPU, 32GB - ~$280/mo on-demand
      use_spot:
        description: 'Use Spot Instance (saves ~70%)'
        required: true
        default: true
        type: boolean

env:
  AWS_REGION: us-east-1
  ROSA_VERSION: "4.18.30"
  WORKER_COUNT: 1

jobs:
  create-minimal-cluster:
    name: Create ROSA HCP Minimal Cluster
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install ROSA CLI
        run: |
          echo "ğŸ“¦ Installing ROSA CLI..."
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/rosa/latest/rosa-linux.tar.gz
          tar -xvf rosa-linux.tar.gz
          sudo mv rosa /usr/local/bin/
          rosa version

      - name: Install OpenShift CLI
        run: |
          echo "ğŸ“¦ Installing OpenShift CLI..."
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/
          oc version --client

      - name: Login to ROSA
        run: |
          rosa login --token=${{ secrets.ROSA_TOKEN }}
          rosa whoami

      - name: Verify prerequisites
        run: |
          echo "ğŸ” Verifying prerequisites..."
          rosa verify quota --region=${{ env.AWS_REGION }}
          rosa verify permissions
          
          echo ""
          echo "ğŸ“‹ Available HCP versions:"
          rosa list versions --hosted-cp 2>/dev/null | grep -E "^4\.18" | head -5 || rosa list versions --hosted-cp | head -10

      - name: Setup VPC and Subnets
        id: network
        run: |
          echo "ğŸŒ Setting up networking..."
          
          CLUSTER_NAME="${{ github.event.inputs.cluster_name }}"
          VPC_CIDR="10.0.0.0/16"
          PUBLIC_SUBNET_CIDR="10.0.1.0/24"
          PRIVATE_SUBNET_CIDR="10.0.2.0/24"
          AZ="${{ env.AWS_REGION }}a"
          
          # Check for existing VPC
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values=${CLUSTER_NAME}-vpc" \
            --query 'Vpcs[0].VpcId' --output text 2>/dev/null)
          
          if [ "$VPC_ID" == "None" ] || [ -z "$VPC_ID" ]; then
            echo "Creating new VPC..."
            
            # Create VPC
            VPC_ID=$(aws ec2 create-vpc \
              --cidr-block $VPC_CIDR \
              --query 'Vpc.VpcId' --output text)
            
            aws ec2 create-tags --resources $VPC_ID \
              --tags Key=Name,Value=${CLUSTER_NAME}-vpc
            
            aws ec2 modify-vpc-attribute --vpc-id $VPC_ID --enable-dns-hostnames '{"Value":true}'
            aws ec2 modify-vpc-attribute --vpc-id $VPC_ID --enable-dns-support '{"Value":true}'
            
            # Create Internet Gateway
            IGW_ID=$(aws ec2 create-internet-gateway \
              --query 'InternetGateway.InternetGatewayId' --output text)
            aws ec2 attach-internet-gateway --vpc-id $VPC_ID --internet-gateway-id $IGW_ID
            aws ec2 create-tags --resources $IGW_ID \
              --tags Key=Name,Value=${CLUSTER_NAME}-igw
            
            # Create Public Subnet
            PUBLIC_SUBNET_ID=$(aws ec2 create-subnet \
              --vpc-id $VPC_ID \
              --cidr-block $PUBLIC_SUBNET_CIDR \
              --availability-zone $AZ \
              --query 'Subnet.SubnetId' --output text)
            aws ec2 create-tags --resources $PUBLIC_SUBNET_ID \
              --tags Key=Name,Value=${CLUSTER_NAME}-public-subnet
            aws ec2 modify-subnet-attribute --subnet-id $PUBLIC_SUBNET_ID --map-public-ip-on-launch
            
            # Create Private Subnet
            PRIVATE_SUBNET_ID=$(aws ec2 create-subnet \
              --vpc-id $VPC_ID \
              --cidr-block $PRIVATE_SUBNET_CIDR \
              --availability-zone $AZ \
              --query 'Subnet.SubnetId' --output text)
            aws ec2 create-tags --resources $PRIVATE_SUBNET_ID \
              --tags Key=Name,Value=${CLUSTER_NAME}-private-subnet
            
            # Create Elastic IP for NAT Gateway
            EIP_ALLOC=$(aws ec2 allocate-address --domain vpc --query 'AllocationId' --output text)
            
            # Create NAT Gateway in public subnet
            NAT_GW_ID=$(aws ec2 create-nat-gateway \
              --subnet-id $PUBLIC_SUBNET_ID \
              --allocation-id $EIP_ALLOC \
              --query 'NatGateway.NatGatewayId' --output text)
            aws ec2 create-tags --resources $NAT_GW_ID \
              --tags Key=Name,Value=${CLUSTER_NAME}-nat
            
            echo "â³ Waiting for NAT Gateway to become available..."
            aws ec2 wait nat-gateway-available --nat-gateway-ids $NAT_GW_ID
            
            # Create Public Route Table
            PUBLIC_RTB_ID=$(aws ec2 create-route-table \
              --vpc-id $VPC_ID \
              --query 'RouteTable.RouteTableId' --output text)
            aws ec2 create-tags --resources $PUBLIC_RTB_ID \
              --tags Key=Name,Value=${CLUSTER_NAME}-public-rtb
            aws ec2 create-route --route-table-id $PUBLIC_RTB_ID \
              --destination-cidr-block 0.0.0.0/0 --gateway-id $IGW_ID
            aws ec2 associate-route-table --subnet-id $PUBLIC_SUBNET_ID --route-table-id $PUBLIC_RTB_ID
            
            # Create Private Route Table
            PRIVATE_RTB_ID=$(aws ec2 create-route-table \
              --vpc-id $VPC_ID \
              --query 'RouteTable.RouteTableId' --output text)
            aws ec2 create-tags --resources $PRIVATE_RTB_ID \
              --tags Key=Name,Value=${CLUSTER_NAME}-private-rtb
            aws ec2 create-route --route-table-id $PRIVATE_RTB_ID \
              --destination-cidr-block 0.0.0.0/0 --nat-gateway-id $NAT_GW_ID
            aws ec2 associate-route-table --subnet-id $PRIVATE_SUBNET_ID --route-table-id $PRIVATE_RTB_ID
            
            echo "âœ… VPC created: $VPC_ID"
            echo "âœ… Public Subnet: $PUBLIC_SUBNET_ID"
            echo "âœ… Private Subnet: $PRIVATE_SUBNET_ID"
          else
            echo "Using existing VPC: $VPC_ID"
            PUBLIC_SUBNET_ID=$(aws ec2 describe-subnets \
              --filters "Name=vpc-id,Values=$VPC_ID" "Name=tag:Name,Values=*public*" \
              --query 'Subnets[0].SubnetId' --output text)
            PRIVATE_SUBNET_ID=$(aws ec2 describe-subnets \
              --filters "Name=vpc-id,Values=$VPC_ID" "Name=tag:Name,Values=*private*" \
              --query 'Subnets[0].SubnetId' --output text)
          fi
          
          echo "vpc_id=$VPC_ID" >> $GITHUB_OUTPUT
          echo "public_subnet_id=$PUBLIC_SUBNET_ID" >> $GITHUB_OUTPUT
          echo "private_subnet_id=$PRIVATE_SUBNET_ID" >> $GITHUB_OUTPUT

      - name: Create or get OIDC config
        id: oidc
        run: |
          echo "ğŸ” Setting up OIDC configuration..."
          
          OIDC_ID=$(rosa list oidc-config -o json 2>/dev/null | jq -r '.[0].id // empty')
          
          if [ -z "$OIDC_ID" ]; then
            echo "Creating new OIDC config..."
            rosa create oidc-config --mode=auto --yes
            sleep 5
            OIDC_ID=$(rosa list oidc-config -o json | jq -r '.[0].id')
          fi
          
          echo "oidc_id=$OIDC_ID" >> $GITHUB_OUTPUT
          echo "âœ… OIDC Config ID: $OIDC_ID"

      - name: Check if cluster exists
        id: check
        run: |
          if rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Cluster '${{ github.event.inputs.cluster_name }}' already exists!"
            rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }}
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Cluster name is available"
          fi

      - name: Create ROSA HCP Cluster with 1 Worker
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "ğŸš€ Creating ROSA HCP cluster with 1 worker node..."
          echo ""
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚  MINIMAL TEST CLUSTER CONFIGURATION     â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚  Control Plane: Hosted (shared)         â”‚"
          echo "â”‚  Worker Nodes:  1x ${{ github.event.inputs.instance_type }}            â”‚"
          echo "â”‚  Spot Instance: ${{ github.event.inputs.use_spot }}                    â”‚"
          echo "â”‚  Version:       ${{ env.ROSA_VERSION }}               â”‚"
          echo "â”‚  Region:        ${{ env.AWS_REGION }}                â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # Build rosa create command
          ROSA_CMD="rosa create cluster \
            --cluster-name=${{ github.event.inputs.cluster_name }} \
            --hosted-cp \
            --region=${{ env.AWS_REGION }} \
            --version=${{ env.ROSA_VERSION }} \
            --compute-machine-type=${{ github.event.inputs.instance_type }} \
            --replicas=${{ env.WORKER_COUNT }} \
            --subnet-ids=${{ steps.network.outputs.private_subnet_id }} \
            --oidc-config-id=${{ steps.oidc.outputs.oidc_id }} \
            --sts \
            --mode=auto \
            --yes"
          
          echo "Executing: $ROSA_CMD"
          eval $ROSA_CMD
          
          echo ""
          echo "â³ Cluster creation initiated. HCP clusters typically take 15-20 minutes."

      - name: Wait for cluster to be ready
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "â³ Waiting for cluster to be ready..."
          
          TIMEOUT=2400  # 40 minutes
          INTERVAL=60
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            STATUS=$(rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} -o json 2>/dev/null | jq -r '.status.state' || echo "pending")
            
            echo "$(date '+%H:%M:%S') - Status: ${STATUS}"
            
            if [ "$STATUS" == "ready" ]; then
              echo ""
              echo "âœ… Cluster is ready!"
              break
            elif [ "$STATUS" == "error" ]; then
              echo "âŒ Cluster creation failed!"
              rosa logs install --cluster=${{ github.event.inputs.cluster_name }} --tail=100
              exit 1
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          FINAL_STATUS=$(rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} -o json | jq -r '.status.state')
          if [ "$FINAL_STATUS" != "ready" ]; then
            echo "âŒ Cluster not ready after timeout. Status: $FINAL_STATUS"
            exit 1
          fi

      - name: Configure Spot Instance (if enabled)
        if: github.event.inputs.use_spot == 'true'
        run: |
          echo "ğŸ¯ Configuring Spot instance for cost savings..."
          
          # Check current machine pools
          rosa list machinepools --cluster=${{ github.event.inputs.cluster_name }}
          
          # Create spot machine pool
          rosa create machinepool \
            --cluster=${{ github.event.inputs.cluster_name }} \
            --name=spot-worker \
            --instance-type=${{ github.event.inputs.instance_type }} \
            --replicas=1 \
            --use-spot-instances \
            --labels=node-type=spot,workload=mortgage-app \
            2>/dev/null || echo "Spot pool may already exist"
          
          # Scale down default workers pool to 0
          rosa edit machinepool \
            --cluster=${{ github.event.inputs.cluster_name }} \
            --replicas=0 \
            workers 2>/dev/null || echo "Default pool already scaled or doesn't exist"
          
          echo ""
          echo "âœ… Spot configuration complete"
          rosa list machinepools --cluster=${{ github.event.inputs.cluster_name }}

      - name: Create cluster admin
        id: admin
        run: |
          echo "ğŸ‘¤ Creating cluster admin user..."
          
          rosa create admin --cluster=${{ github.event.inputs.cluster_name }} 2>/dev/null || true
          
          echo ""
          echo "To retrieve admin credentials, run:"
          echo "  rosa describe admin --cluster=${{ github.event.inputs.cluster_name }}"

      - name: Get cluster information
        id: info
        run: |
          echo ""
          echo "ğŸ“Š Cluster Information"
          echo "======================"
          
          rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }}
          
          API_URL=$(rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} -o json | jq -r '.api.url')
          CONSOLE_URL=$(rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} -o json | jq -r '.console.url')
          
          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "console_url=${CONSOLE_URL}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ–¥ï¸ Machine Pools:"
          rosa list machinepools --cluster=${{ github.event.inputs.cluster_name }}
          
          echo ""
          echo "ğŸ”— Access URLs:"
          echo "  API: ${API_URL}"
          echo "  Console: ${CONSOLE_URL}"

      - name: Summary
        run: |
          # Calculate costs
          if [ "${{ github.event.inputs.use_spot }}" == "true" ]; then
            case "${{ github.event.inputs.instance_type }}" in
              "m5.large")   WORKER_COST="~22" ;;
              "m5.xlarge")  WORKER_COST="~45" ;;
              "m5.2xlarge") WORKER_COST="~90" ;;
              *)            WORKER_COST="~45" ;;
            esac
          else
            case "${{ github.event.inputs.instance_type }}" in
              "m5.large")   WORKER_COST="~70" ;;
              "m5.xlarge")  WORKER_COST="~140" ;;
              "m5.2xlarge") WORKER_COST="~280" ;;
              *)            WORKER_COST="~140" ;;
            esac
          fi
          
          echo "## ğŸ‰ ROSA HCP Minimal Cluster Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ’° Estimated Monthly Cost" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Cost |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Hosted Control Plane | ~\$30 |" >> $GITHUB_STEP_SUMMARY
          echo "| 1x ${{ github.event.inputs.instance_type }} Worker (Spot: ${{ github.event.inputs.use_spot }}) | $WORKER_COST |" >> $GITHUB_STEP_SUMMARY
          echo "| NAT Gateway | ~\$32 |" >> $GITHUB_STEP_SUMMARY
          echo "| EBS Storage | ~\$10 |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **~\$$(( 30 + ${WORKER_COST//[~$]/} + 32 + 10 ))/month** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cluster Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster Name | \`${{ github.event.inputs.cluster_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Type | **Hosted Control Plane (HCP)** |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ env.ROSA_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | \`${{ env.AWS_REGION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker Nodes | **1** |" >> $GITHUB_STEP_SUMMARY
          echo "| Instance Type | \`${{ github.event.inputs.instance_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Spot Instance | ${{ github.event.inputs.use_spot }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API URL | ${{ steps.info.outputs.api_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Console | ${{ steps.info.outputs.console_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Single Worker Node Limitations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "With 1 worker node:" >> $GITHUB_STEP_SUMMARY
          echo "- No high availability (if node fails, all pods go down)" >> $GITHUB_STEP_SUMMARY
          echo "- Limited resources (~4 vCPU, ~14GB usable for pods)" >> $GITHUB_STEP_SUMMARY
          echo "- Suitable for: dev/test, demos, learning" >> $GITHUB_STEP_SUMMARY
          echo "- NOT suitable for: production, load testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Get admin credentials:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   rosa describe admin --cluster=${{ github.event.inputs.cluster_name }}" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Login to cluster:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   oc login ${{ steps.info.outputs.api_url }} --username cluster-admin --password <password>" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **Create namespace and deploy:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   oc new-project mortgage-app" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Final output
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… ROSA HCP MINIMAL CLUSTER CREATED SUCCESSFULLY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  Cluster:  ${{ github.event.inputs.cluster_name }}"
          echo "  Workers:  1x ${{ github.event.inputs.instance_type }}"
          echo "  Spot:     ${{ github.event.inputs.use_spot }}"
          echo ""
          echo "  Get credentials:"
          echo "    rosa describe admin --cluster=${{ github.event.inputs.cluster_name }}"
          echo ""
          echo "  Console:"
          echo "    ${{ steps.info.outputs.console_url }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
