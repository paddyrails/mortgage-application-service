name: Create ROSA Test Cluster (4.18.30)

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: 'Cluster name'
        required: true
        default: 'mortgage-test'
      use_spot:
        description: 'Use Spot Instances for workers (saves ~70%)'
        required: true
        default: true
        type: boolean
      worker_count:
        description: 'Number of worker nodes'
        required: true
        default: '2'
        type: choice
        options:
          - '2'
          - '3'
          - '4'

env:
  AWS_REGION: us-east-1
  ROSA_VERSION: "4.18.30"
  INSTANCE_TYPE: m5.xlarge
  OPENSHIFT_NAMESPACE: mortgage-app

jobs:
  create-cluster:
    name: Create ROSA Test Cluster
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install ROSA CLI
        run: |
          echo "üì¶ Installing ROSA CLI..."
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/rosa/latest/rosa-linux.tar.gz
          tar -xvf rosa-linux.tar.gz
          sudo mv rosa /usr/local/bin/
          rosa version

      - name: Install OpenShift CLI
        run: |
          echo "üì¶ Installing OpenShift CLI..."
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/
          oc version --client

      - name: Login to ROSA
        run: |
          echo "üîê Logging in to ROSA..."
          rosa login --token=${{ secrets.ROSA_TOKEN }}
          rosa whoami

      - name: Verify prerequisites
        run: |
          echo "üîç Verifying AWS quotas..."
          rosa verify quota --region=${{ env.AWS_REGION }}
          
          echo ""
          echo "üîç Verifying AWS permissions..."
          rosa verify permissions
          
          echo ""
          echo "üîç Available ROSA versions:"
          rosa list versions | grep -E "^4\.18" | head -5

      - name: Check if cluster exists
        id: check
        run: |
          if rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Cluster '${{ github.event.inputs.cluster_name }}' already exists!"
            rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }}
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Cluster name '${{ github.event.inputs.cluster_name }}' is available"
          fi

      - name: Create ROSA Cluster
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "üöÄ Creating ROSA cluster: ${{ github.event.inputs.cluster_name }}"
          echo "   Version: ${{ env.ROSA_VERSION }}"
          echo "   Region: ${{ env.AWS_REGION }}"
          echo "   Instance Type: ${{ env.INSTANCE_TYPE }}"
          echo "   Workers: ${{ github.event.inputs.worker_count }}"
          echo ""
          
          # Create cluster with STS (recommended)
          rosa create cluster \
            --cluster-name=${{ github.event.inputs.cluster_name }} \
            --region=${{ env.AWS_REGION }} \
            --version=${{ env.ROSA_VERSION }} \
            --compute-machine-type=${{ env.INSTANCE_TYPE }} \
            --replicas=${{ github.event.inputs.worker_count }} \
            --machine-cidr=10.0.0.0/16 \
            --service-cidr=172.30.0.0/16 \
            --pod-cidr=10.128.0.0/14 \
            --host-prefix=23 \
            --multi-az=false \
            --sts \
            --mode=auto \
            --yes
          
          echo ""
          echo "‚è≥ Cluster creation initiated. This typically takes 30-45 minutes."

      - name: Wait for cluster installation
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "‚è≥ Waiting for cluster to be ready..."
          echo "   This takes approximately 30-45 minutes."
          echo ""
          
          # Wait for cluster to be ready (timeout 60 minutes)
          TIMEOUT=3600
          INTERVAL=120
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            STATUS=$(rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} -o json 2>/dev/null | jq -r '.status.state' || echo "unknown")
            
            echo "$(date '+%H:%M:%S') - Cluster status: ${STATUS}"
            
            if [ "$STATUS" == "ready" ]; then
              echo ""
              echo "‚úÖ Cluster is ready!"
              break
            elif [ "$STATUS" == "error" ]; then
              echo ""
              echo "‚ùå Cluster creation failed!"
              rosa logs install --cluster=${{ github.event.inputs.cluster_name }} --tail=100
              exit 1
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          # Final status check
          FINAL_STATUS=$(rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} -o json | jq -r '.status.state')
          if [ "$FINAL_STATUS" != "ready" ]; then
            echo "‚ùå Cluster not ready after 60 minutes. Current status: ${FINAL_STATUS}"
            exit 1
          fi

      - name: Create Spot Instance Machine Pool
        if: github.event.inputs.use_spot == 'true'
        run: |
          echo "üéØ Creating Spot Instance machine pool for cost savings..."
          
          # Check if spot pool already exists
          if rosa list machinepools --cluster=${{ github.event.inputs.cluster_name }} | grep -q "spot-workers"; then
            echo "Spot machine pool already exists"
          else
            rosa create machinepool \
              --cluster=${{ github.event.inputs.cluster_name }} \
              --name=spot-workers \
              --instance-type=${{ env.INSTANCE_TYPE }} \
              --replicas=${{ github.event.inputs.worker_count }} \
              --use-spot-instances \
              --labels=node-type=spot,workload=mortgage-app
            
            echo "‚úÖ Spot machine pool created"
          fi

      - name: Scale down default on-demand pool
        if: github.event.inputs.use_spot == 'true'
        run: |
          echo "‚¨áÔ∏è Scaling down default (on-demand) machine pool to save costs..."
          
          # Scale default worker pool to 0
          rosa edit machinepool \
            --cluster=${{ github.event.inputs.cluster_name }} \
            --replicas=0 \
            worker 2>/dev/null || echo "Default pool may not exist or already scaled"
          
          echo "‚úÖ Default pool scaled down. Workloads will run on Spot instances."

      - name: Create cluster admin
        id: admin
        run: |
          echo "üë§ Creating cluster admin user..."
          
          # Check if admin exists
          ADMIN_EXISTS=$(rosa describe admin --cluster=${{ github.event.inputs.cluster_name }} 2>&1 || echo "not found")
          
          if echo "$ADMIN_EXISTS" | grep -q "not found\|does not exist"; then
            # Create new admin
            ADMIN_OUTPUT=$(rosa create admin --cluster=${{ github.event.inputs.cluster_name }})
            echo "$ADMIN_OUTPUT"
            
            # Extract password (it's shown in the output)
            PASSWORD=$(echo "$ADMIN_OUTPUT" | grep -oP '(?<=--password )\S+' || echo "check-rosa-output")
            echo "admin_password=${PASSWORD}" >> $GITHUB_OUTPUT
          else
            echo "Admin user already exists"
            echo "Run: rosa describe admin --cluster=${{ github.event.inputs.cluster_name }}"
          fi

      - name: Get cluster information
        id: info
        run: |
          echo "üìä Cluster Information"
          echo "======================"
          echo ""
          
          rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }}
          
          # Extract URLs
          API_URL=$(rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} -o json | jq -r '.api.url')
          CONSOLE_URL=$(rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} -o json | jq -r '.console.url')
          
          echo ""
          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "console_url=${CONSOLE_URL}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "üñ•Ô∏è Machine Pools:"
          rosa list machinepools --cluster=${{ github.event.inputs.cluster_name }}

      - name: Create mortgage-app namespace
        run: |
          echo "üìÅ Creating mortgage-app namespace..."
          
          # Get cluster credentials
          API_URL=$(rosa describe cluster --cluster=${{ github.event.inputs.cluster_name }} -o json | jq -r '.api.url')
          
          # Login to cluster (using token from ROSA)
          oc login "$API_URL" --username=cluster-admin --password="${{ steps.admin.outputs.admin_password }}" --insecure-skip-tls-verify=true 2>/dev/null || echo "Will create namespace after manual login"
          
          # Try to create namespace
          oc new-project ${{ env.OPENSHIFT_NAMESPACE }} 2>/dev/null || echo "Namespace may already exist or requires manual creation"

      - name: Summary
        run: |
          echo "## üéâ ROSA Test Cluster Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cluster Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster Name | \`${{ github.event.inputs.cluster_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| OpenShift Version | \`${{ env.ROSA_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | \`${{ env.AWS_REGION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Instance Type | \`${{ env.INSTANCE_TYPE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker Count | ${{ github.event.inputs.worker_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Spot Instances | ${{ github.event.inputs.use_spot }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API URL | ${{ steps.info.outputs.api_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Console URL | ${{ steps.info.outputs.console_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Estimated Monthly Cost" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.use_spot }}" == "true" ]; then
            echo "| Component | Cost |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| ROSA Control Plane | ~\$500 |" >> $GITHUB_STEP_SUMMARY
            echo "| Spot Workers (${{ github.event.inputs.worker_count }}x m5.xlarge) | ~\$45-90 |" >> $GITHUB_STEP_SUMMARY
            echo "| EBS Storage | ~\$25 |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | **~\$570-615/month** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Component | Cost |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| ROSA Control Plane | ~\$500 |" >> $GITHUB_STEP_SUMMARY
            echo "| On-Demand Workers (${{ github.event.inputs.worker_count }}x m5.xlarge) | ~\$280 |" >> $GITHUB_STEP_SUMMARY
            echo "| EBS Storage | ~\$25 |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | **~\$805/month** |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Get admin credentials:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   rosa describe admin --cluster=${{ github.event.inputs.cluster_name }}" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Login to cluster:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   oc login ${{ steps.info.outputs.api_url }} --username cluster-admin --password <password>" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **Access OpenShift Console:**" >> $GITHUB_STEP_SUMMARY
          echo "   ${{ steps.info.outputs.console_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "4. **Deploy microservices:**" >> $GITHUB_STEP_SUMMARY
          echo "   Run the deploy workflows for each service in order:" >> $GITHUB_STEP_SUMMARY
          echo "   - customer-service ‚Üí property-service ‚Üí loans-service ‚Üí payments-service ‚Üí application-service" >> $GITHUB_STEP_SUMMARY

      - name: Output credentials info
        run: |
          echo ""
          echo "=========================================="
          echo "üîê IMPORTANT: Save your admin credentials"
          echo "=========================================="
          echo ""
          echo "To get your admin password, run:"
          echo "  rosa describe admin --cluster=${{ github.event.inputs.cluster_name }}"
          echo ""
          echo "Or create a new admin if needed:"
          echo "  rosa create admin --cluster=${{ github.event.inputs.cluster_name }}"
          echo ""
