name: Run Database Migrations

# ============================================================
# Runs EF Core migrations for a specific microservice
# Each service manages its own schema migrations
# ============================================================

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to migrate'
        required: true
        type: choice
        options:
          - customer-service
          - property-service
          - loans-service
          - payments-service
          - application-service
      namespace:
        description: 'Namespace'
        required: true
        default: 'mortgage-app'
      migration_action:
        description: 'Migration action'
        required: true
        default: 'update'
        type: choice
        options:
          - update
          - script
          - rollback

jobs:
  run-migrations:
    name: Run Migrations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/${{ github.event.inputs.service }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install EF Core Tools
        run: dotnet tool install --global dotnet-ef

      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify=true

      - name: Get Connection String
        id: db
        run: |
          SERVICE_NAME=$(echo "${{ github.event.inputs.service }}" | sed 's/-service//')
          SECRET_NAME="postgresql-${SERVICE_NAME}-service"
          
          CONN_STRING=$(oc get secret $SECRET_NAME -n ${{ github.event.inputs.namespace }} -o jsonpath='{.data.CONNECTION_STRING}' | base64 -d)
          
          if [ -z "$CONN_STRING" ]; then
            echo "âŒ Could not get connection string from secret $SECRET_NAME"
            exit 1
          fi
          
          echo "connection_string=$CONN_STRING" >> $GITHUB_OUTPUT
          echo "âœ… Got connection string"

      - name: Port Forward PostgreSQL
        run: |
          echo "ðŸ”Œ Setting up port forward..."
          oc port-forward svc/postgresql 5432:5432 -n ${{ github.event.inputs.namespace }} &
          sleep 5
          echo "âœ… Port forward established"

      - name: Run Migration - Update
        if: github.event.inputs.migration_action == 'update'
        env:
          ConnectionStrings__DefaultConnection: ${{ steps.db.outputs.connection_string }}
        run: |
          echo "ðŸš€ Running migrations..."
          
          # Find the project file
          PROJECT=$(find . -name "*.csproj" -type f | head -1)
          
          if [ -z "$PROJECT" ]; then
            echo "âŒ No .csproj file found"
            exit 1
          fi
          
          echo "Project: $PROJECT"
          
          # Update connection string to use localhost (port-forwarded)
          export ConnectionStrings__DefaultConnection=$(echo "${{ steps.db.outputs.connection_string }}" | sed 's/Host=postgresql/Host=localhost/')
          
          dotnet ef database update --project "$PROJECT" --verbose
          
          echo "âœ… Migrations applied"

      - name: Run Migration - Script
        if: github.event.inputs.migration_action == 'script'
        run: |
          echo "ðŸ“ Generating migration script..."
          
          PROJECT=$(find . -name "*.csproj" -type f | head -1)
          
          dotnet ef migrations script --project "$PROJECT" --idempotent -o migration.sql
          
          echo "=== Migration Script ==="
          cat migration.sql

      - name: Run Migration - Rollback
        if: github.event.inputs.migration_action == 'rollback'
        env:
          ConnectionStrings__DefaultConnection: ${{ steps.db.outputs.connection_string }}
        run: |
          echo "âª Rolling back last migration..."
          
          PROJECT=$(find . -name "*.csproj" -type f | head -1)
          
          export ConnectionStrings__DefaultConnection=$(echo "${{ steps.db.outputs.connection_string }}" | sed 's/Host=postgresql/Host=localhost/')
          
          # Get previous migration
          MIGRATIONS=$(dotnet ef migrations list --project "$PROJECT" --no-build 2>/dev/null | tail -5)
          echo "Recent migrations:"
          echo "$MIGRATIONS"
          
          # Rollback to previous
          PREVIOUS=$(echo "$MIGRATIONS" | tail -2 | head -1 | tr -d ' ')
          if [ -n "$PREVIOUS" ]; then
            echo "Rolling back to: $PREVIOUS"
            dotnet ef database update "$PREVIOUS" --project "$PROJECT"
          else
            echo "âš ï¸ No previous migration to rollback to"
          fi

      - name: Verify Schema
        run: |
          echo "ðŸ” Verifying schema..."
          
          POD=$(oc get pod -n ${{ github.event.inputs.namespace }} -l app=postgresql -o jsonpath='{.items[0].metadata.name}')
          SERVICE_NAME=$(echo "${{ github.event.inputs.service }}" | sed 's/-service//')
          SCHEMA="${SERVICE_NAME}_service"
          
          echo "Tables in ${SCHEMA}:"
          oc exec -n ${{ github.event.inputs.namespace }} $POD -- psql -U postgres -d mortgage_db -c "SELECT table_name FROM information_schema.tables WHERE table_schema = '${SCHEMA}';"

      - name: Summary
        run: |
          echo "## ðŸ—ƒï¸ Migration Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Service | ${{ github.event.inputs.service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Action | ${{ github.event.inputs.migration_action }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace | ${{ github.event.inputs.namespace }} |" >> $GITHUB_STEP_SUMMARY
