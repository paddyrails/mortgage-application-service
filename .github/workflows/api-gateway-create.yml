name: Create API Gateway for Microservices

# ============================================================
# Creates AWS API Gateway to route traffic to OpenShift services
# 
# Architecture:
#   Internet â†’ API Gateway â†’ NLB â†’ OpenShift Routes â†’ Services
#
# Endpoints created:
#   /api/customers/*     â†’ customer-service
#   /api/properties/*    â†’ property-service
#   /api/loans/*         â†’ loans-service
#   /api/payments/*      â†’ payments-service
#   /api/applications/*  â†’ application-service
# ============================================================

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: 'OpenShift cluster name'
        required: true
        default: 'mortgage-test'
      environment:
        description: 'Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      api_gateway_name:
        description: 'API Gateway name'
        required: true
        default: 'mortgage-api'
      create_custom_domain:
        description: 'Create custom domain (requires ACM certificate)'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-east-1
  OPENSHIFT_NAMESPACE: mortgage-app

jobs:
  create-api-gateway:
    name: Create API Gateway
    runs-on: ubuntu-latest
    
    outputs:
      api_gateway_id: ${{ steps.create-api.outputs.api_id }}
      api_endpoint: ${{ steps.deploy-api.outputs.endpoint }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify=true

      - name: Get OpenShift Route URLs
        id: routes
        run: |
          echo "ðŸ” Getting OpenShift route URLs..."
          
          oc project ${{ env.OPENSHIFT_NAMESPACE }}
          
          # Get route URLs for each service
          CUSTOMER_URL=$(oc get route customer-service -o jsonpath='{.spec.host}' 2>/dev/null || echo "")
          PROPERTY_URL=$(oc get route property-service -o jsonpath='{.spec.host}' 2>/dev/null || echo "")
          LOANS_URL=$(oc get route loans-service -o jsonpath='{.spec.host}' 2>/dev/null || echo "")
          PAYMENTS_URL=$(oc get route payments-service -o jsonpath='{.spec.host}' 2>/dev/null || echo "")
          APPLICATION_URL=$(oc get route application-service -o jsonpath='{.spec.host}' 2>/dev/null || echo "")
          
          echo "customer_url=$CUSTOMER_URL" >> $GITHUB_OUTPUT
          echo "property_url=$PROPERTY_URL" >> $GITHUB_OUTPUT
          echo "loans_url=$LOANS_URL" >> $GITHUB_OUTPUT
          echo "payments_url=$PAYMENTS_URL" >> $GITHUB_OUTPUT
          echo "application_url=$APPLICATION_URL" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸ“Š Route URLs:"
          echo "  Customer:    https://$CUSTOMER_URL"
          echo "  Property:    https://$PROPERTY_URL"
          echo "  Loans:       https://$LOANS_URL"
          echo "  Payments:    https://$PAYMENTS_URL"
          echo "  Application: https://$APPLICATION_URL"

      - name: Create API Gateway
        id: create-api
        run: |
          echo "ðŸš€ Creating API Gateway..."
          
          API_NAME="${{ github.event.inputs.api_gateway_name }}-${{ github.event.inputs.environment }}"
          
          # Check if API already exists
          EXISTING_API=$(aws apigatewayv2 get-apis \
            --query "Items[?Name=='${API_NAME}'].ApiId" \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$EXISTING_API" ] && [ "$EXISTING_API" != "None" ]; then
            echo "API Gateway already exists: $EXISTING_API"
            API_ID=$EXISTING_API
          else
            # Create HTTP API Gateway
            API_ID=$(aws apigatewayv2 create-api \
              --name "$API_NAME" \
              --protocol-type HTTP \
              --description "API Gateway for Mortgage Microservices (${{ github.event.inputs.environment }})" \
              --cors-configuration '{
                "AllowOrigins": ["*"],
                "AllowMethods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
                "AllowHeaders": ["Content-Type", "Authorization", "X-Requested-With"],
                "MaxAge": 86400
              }' \
              --query 'ApiId' \
              --output text)
            
            echo "âœ… API Gateway created: $API_ID"
          fi
          
          echo "api_id=$API_ID" >> $GITHUB_OUTPUT
          echo "api_name=$API_NAME" >> $GITHUB_OUTPUT

      - name: Create VPC Link (for private integration)
        id: vpc-link
        run: |
          echo "ðŸ”— Setting up VPC Link..."
          
          VPC_LINK_NAME="${{ github.event.inputs.cluster_name }}-vpc-link"
          
          # Check if VPC Link exists
          EXISTING_VPC_LINK=$(aws apigatewayv2 get-vpc-links \
            --query "Items[?Name=='${VPC_LINK_NAME}'].VpcLinkId" \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$EXISTING_VPC_LINK" ] && [ "$EXISTING_VPC_LINK" != "None" ]; then
            echo "VPC Link already exists: $EXISTING_VPC_LINK"
            VPC_LINK_ID=$EXISTING_VPC_LINK
          else
            # Get VPC and Subnets from cluster
            VPC_ID=$(aws ec2 describe-vpcs \
              --filters "Name=tag:Name,Values=${{ github.event.inputs.cluster_name }}-vpc" \
              --query 'Vpcs[0].VpcId' --output text)
            
            SUBNET_IDS=$(aws ec2 describe-subnets \
              --filters "Name=vpc-id,Values=$VPC_ID" "Name=tag:Name,Values=*private*" \
              --query 'Subnets[*].SubnetId' --output text | tr '\t' ',')
            
            # Get security group
            SG_ID=$(aws ec2 describe-security-groups \
              --filters "Name=vpc-id,Values=$VPC_ID" "Name=group-name,Values=default" \
              --query 'SecurityGroups[0].GroupId' --output text)
            
            # Create VPC Link
            VPC_LINK_ID=$(aws apigatewayv2 create-vpc-link \
              --name "$VPC_LINK_NAME" \
              --subnet-ids ${SUBNET_IDS//,/ } \
              --security-group-ids $SG_ID \
              --query 'VpcLinkId' \
              --output text)
            
            echo "â³ Waiting for VPC Link to be available..."
            sleep 30
            
            echo "âœ… VPC Link created: $VPC_LINK_ID"
          fi
          
          echo "vpc_link_id=$VPC_LINK_ID" >> $GITHUB_OUTPUT

      - name: Create Integrations and Routes
        run: |
          echo "ðŸ› ï¸ Creating integrations and routes..."
          
          API_ID="${{ steps.create-api.outputs.api_id }}"
          
          # Define services and their routes
          declare -A SERVICES
          SERVICES["customer-service"]="${{ steps.routes.outputs.customer_url }}"
          SERVICES["property-service"]="${{ steps.routes.outputs.property_url }}"
          SERVICES["loans-service"]="${{ steps.routes.outputs.loans_url }}"
          SERVICES["payments-service"]="${{ steps.routes.outputs.payments_url }}"
          SERVICES["application-service"]="${{ steps.routes.outputs.application_url }}"
          
          declare -A ROUTES
          ROUTES["customer-service"]="/api/customers"
          ROUTES["property-service"]="/api/properties"
          ROUTES["loans-service"]="/api/loans"
          ROUTES["payments-service"]="/api/payments"
          ROUTES["application-service"]="/api/applications"
          
          for SERVICE in "${!SERVICES[@]}"; do
            URL="${SERVICES[$SERVICE]}"
            ROUTE_PATH="${ROUTES[$SERVICE]}"
            
            if [ -z "$URL" ] || [ "$URL" == "None" ]; then
              echo "âš ï¸ Skipping $SERVICE - no route URL found"
              continue
            fi
            
            echo ""
            echo "Creating integration for $SERVICE..."
            
            # Create HTTP integration
            INTEGRATION_ID=$(aws apigatewayv2 create-integration \
              --api-id $API_ID \
              --integration-type HTTP_PROXY \
              --integration-method ANY \
              --integration-uri "https://${URL}${ROUTE_PATH}/{proxy}" \
              --payload-format-version "1.0" \
              --query 'IntegrationId' \
              --output text 2>/dev/null || echo "")
            
            if [ -n "$INTEGRATION_ID" ]; then
              echo "  âœ… Integration: $INTEGRATION_ID"
              
              # Create route with proxy
              aws apigatewayv2 create-route \
                --api-id $API_ID \
                --route-key "ANY ${ROUTE_PATH}/{proxy+}" \
                --target "integrations/$INTEGRATION_ID" \
                2>/dev/null || echo "  Route may already exist"
              
              # Create route for exact path
              aws apigatewayv2 create-route \
                --api-id $API_ID \
                --route-key "ANY ${ROUTE_PATH}" \
                --target "integrations/$INTEGRATION_ID" \
                2>/dev/null || echo "  Route may already exist"
              
              echo "  âœ… Routes created for ${ROUTE_PATH}"
            fi
          done

      - name: Create Health Check Route
        run: |
          echo "â¤ï¸ Creating health check route..."
          
          API_ID="${{ steps.create-api.outputs.api_id }}"
          
          # Create a simple health check integration
          HEALTH_INTEGRATION=$(aws apigatewayv2 create-integration \
            --api-id $API_ID \
            --integration-type HTTP_PROXY \
            --integration-method GET \
            --integration-uri "https://${{ steps.routes.outputs.customer_url }}/api/health" \
            --query 'IntegrationId' \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$HEALTH_INTEGRATION" ]; then
            aws apigatewayv2 create-route \
              --api-id $API_ID \
              --route-key "GET /health" \
              --target "integrations/$HEALTH_INTEGRATION" \
              2>/dev/null || true
            
            echo "âœ… Health check route created"
          fi

      - name: Deploy API Gateway
        id: deploy-api
        run: |
          echo "ðŸš€ Deploying API Gateway..."
          
          API_ID="${{ steps.create-api.outputs.api_id }}"
          STAGE_NAME="${{ github.event.inputs.environment }}"
          
          # Check if stage exists
          EXISTING_STAGE=$(aws apigatewayv2 get-stages \
            --api-id $API_ID \
            --query "Items[?StageName=='${STAGE_NAME}'].StageName" \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$EXISTING_STAGE" ] && [ "$EXISTING_STAGE" != "None" ]; then
            echo "Stage already exists, updating..."
          else
            # Create stage with auto-deploy
            aws apigatewayv2 create-stage \
              --api-id $API_ID \
              --stage-name $STAGE_NAME \
              --auto-deploy \
              --description "Mortgage API - ${{ github.event.inputs.environment }}"
          fi
          
          # Get the endpoint URL
          ENDPOINT=$(aws apigatewayv2 get-api \
            --api-id $API_ID \
            --query 'ApiEndpoint' \
            --output text)
          
          FULL_ENDPOINT="${ENDPOINT}/${STAGE_NAME}"
          
          echo "endpoint=$FULL_ENDPOINT" >> $GITHUB_OUTPUT
          echo ""
          echo "âœ… API Gateway deployed!"
          echo "   Endpoint: $FULL_ENDPOINT"

      - name: Create API Key and Usage Plan (Optional)
        if: github.event.inputs.environment == 'prod'
        run: |
          echo "ðŸ”‘ Creating API Key and Usage Plan for production..."
          
          API_ID="${{ steps.create-api.outputs.api_id }}"
          
          # Note: API Keys work differently with HTTP APIs vs REST APIs
          # For HTTP APIs, you typically use Lambda authorizers or JWT
          
          echo "â„¹ï¸ For HTTP APIs, consider using:"
          echo "   - JWT Authorizer (Cognito, Auth0, etc.)"
          echo "   - Lambda Authorizer"
          echo "   - IAM Authorization"

      - name: Setup CloudWatch Logging
        run: |
          echo "ðŸ“Š Setting up CloudWatch logging..."
          
          API_ID="${{ steps.create-api.outputs.api_id }}"
          STAGE_NAME="${{ github.event.inputs.environment }}"
          
          # Create log group
          LOG_GROUP="/aws/apigateway/${{ github.event.inputs.api_gateway_name }}-${{ github.event.inputs.environment }}"
          
          aws logs create-log-group \
            --log-group-name "$LOG_GROUP" \
            2>/dev/null || echo "Log group may already exist"
          
          # Update stage with logging
          aws apigatewayv2 update-stage \
            --api-id $API_ID \
            --stage-name $STAGE_NAME \
            --access-log-settings '{
              "DestinationArn": "arn:aws:logs:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:log-group:'"$LOG_GROUP"'",
              "Format": "{\"requestId\":\"$context.requestId\",\"ip\":\"$context.identity.sourceIp\",\"requestTime\":\"$context.requestTime\",\"httpMethod\":\"$context.httpMethod\",\"routeKey\":\"$context.routeKey\",\"status\":\"$context.status\",\"responseLength\":\"$context.responseLength\",\"integrationLatency\":\"$context.integrationLatency\"}"
            }' \
            2>/dev/null || echo "Logging configuration may require additional permissions"
          
          echo "âœ… CloudWatch logging configured"

      - name: Test API Gateway
        run: |
          echo "ðŸ§ª Testing API Gateway endpoints..."
          
          ENDPOINT="${{ steps.deploy-api.outputs.endpoint }}"
          
          echo ""
          echo "Testing health endpoint..."
          curl -s -o /dev/null -w "Health: %{http_code}\n" "${ENDPOINT}/health" || true
          
          echo ""
          echo "Testing service endpoints..."
          curl -s -o /dev/null -w "Customers: %{http_code}\n" "${ENDPOINT}/api/customers" || true
          curl -s -o /dev/null -w "Properties: %{http_code}\n" "${ENDPOINT}/api/properties" || true
          curl -s -o /dev/null -w "Loans: %{http_code}\n" "${ENDPOINT}/api/loans" || true
          curl -s -o /dev/null -w "Payments: %{http_code}\n" "${ENDPOINT}/api/payments" || true
          curl -s -o /dev/null -w "Applications: %{http_code}\n" "${ENDPOINT}/api/applications" || true

      - name: Summary
        run: |
          echo "## ðŸŽ‰ API Gateway Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API Gateway Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Name | \`${{ steps.create-api.outputs.api_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ID | \`${{ steps.create-api.outputs.api_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ github.event.inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | ${{ steps.deploy-api.outputs.endpoint }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Endpoint |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | \`GET ${{ steps.deploy-api.outputs.endpoint }}/health\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Customer Service | \`${{ steps.deploy-api.outputs.endpoint }}/api/customers\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Property Service | \`${{ steps.deploy-api.outputs.endpoint }}/api/properties\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Loans Service | \`${{ steps.deploy-api.outputs.endpoint }}/api/loans\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Payments Service | \`${{ steps.deploy-api.outputs.endpoint }}/api/payments\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Application Service | \`${{ steps.deploy-api.outputs.endpoint }}/api/applications\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Example Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Get all customers" >> $GITHUB_STEP_SUMMARY
          echo "curl ${{ steps.deploy-api.outputs.endpoint }}/api/customers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Create a new customer" >> $GITHUB_STEP_SUMMARY
          echo "curl -X POST ${{ steps.deploy-api.outputs.endpoint }}/api/customers \\" >> $GITHUB_STEP_SUMMARY
          echo "  -H 'Content-Type: application/json' \\" >> $GITHUB_STEP_SUMMARY
          echo "  -d '{\"firstName\": \"John\", \"lastName\": \"Doe\"}'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
