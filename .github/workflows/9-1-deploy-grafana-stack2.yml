name: 9.1 Deploy Grafana Stack

# ============================================================
# Deploys Grafana observability stack on OpenShift:
# - Grafana: Visualization and dashboards
# - Loki: Log aggregation (lightweight alternative to ELK)
# - Promtail: Log collector (ships logs to Loki)
# - Prometheus: Metrics collection (optional)
#
# Architecture:
#   Microservices â†’ Promtail â†’ Loki â†’ Grafana
#                              â†‘
#                         Prometheus (metrics)
#
# OPENSHIFT COMPATIBLE - Uses proper security contexts
# ============================================================

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: "Namespace for Grafana stack"
        required: true
        default: "monitoring"
      grafana_admin_password:
        description: "Grafana admin password (leave empty for auto-generated)"
        required: false
        default: ""
      storage_size:
        description: "Storage size for Loki"
        required: true
        default: "10Gi"
        type: choice
        options:
          - "5Gi"
          - "10Gi"
          - "20Gi"
          - "50Gi"
      install_prometheus:
        description: "Also install Prometheus for metrics"
        required: true
        default: false
        type: boolean

env:
  APP_NAMESPACE: mortgage-app

jobs:
  deploy-grafana-stack:
    name: Deploy Grafana Stack
    runs-on: ubuntu-latest

    outputs:
      grafana_url: ${{ steps.grafana-route.outputs.url }}
      grafana_password: ${{ steps.grafana-secret.outputs.password }}

    steps:
      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Login to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify=true

      - name: Create Monitoring Namespace
        run: |
          echo "ğŸ“ Creating monitoring namespace..."

          oc create namespace ${{ github.event.inputs.namespace }} 2>/dev/null || echo "Namespace exists"

          # Add labels for OpenShift - use baseline instead of restricted for monitoring tools
          oc label namespace ${{ github.event.inputs.namespace }} \
            openshift.io/cluster-monitoring=true \
            pod-security.kubernetes.io/enforce=baseline \
            pod-security.kubernetes.io/warn=baseline \
            --overwrite

          oc project ${{ github.event.inputs.namespace }}

      - name: Generate Grafana Admin Password
        id: grafana-secret
        run: |
          if [ -n "${{ github.event.inputs.grafana_admin_password }}" ]; then
            GRAFANA_PASSWORD="${{ github.event.inputs.grafana_admin_password }}"
          else
            GRAFANA_PASSWORD=$(openssl rand -base64 12)
          fi

          echo "password=$GRAFANA_PASSWORD" >> $GITHUB_OUTPUT

          # Create secret for Grafana
          oc create secret generic grafana-admin-credentials \
            --from-literal=admin-user=admin \
            --from-literal=admin-password="$GRAFANA_PASSWORD" \
            -n ${{ github.event.inputs.namespace }} \
            --dry-run=client -o yaml | oc apply -f -

          echo "âœ… Grafana admin credentials created"

      - name: Add Helm Repositories
        run: |
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update

      - name: Deploy Loki (Log Aggregation)
        run: |
          echo "ğŸ“¦ Deploying Loki (OpenShift-compatible)..."

          # Use loki-stack which is simpler and more compatible with OpenShift
          cat <<EOF > /tmp/loki-values.yaml
          loki:
            enabled: true
            isDefault: true
            persistence:
              enabled: true
              size: ${{ github.event.inputs.storage_size }}
            config:
              auth_enabled: false
              ingester:
                chunk_idle_period: 3m
                chunk_block_size: 262144
                chunk_retain_period: 1m
              schema_config:
                configs:
                  - from: 2024-01-01
                    store: boltdb-shipper
                    object_store: filesystem
                    schema: v11
                    index:
                      prefix: index_
                      period: 24h
              storage_config:
                boltdb_shipper:
                  active_index_directory: /data/loki/boltdb-shipper-active
                  cache_location: /data/loki/boltdb-shipper-cache
                  shared_store: filesystem
                filesystem:
                  directory: /data/loki/chunks
              limits_config:
                enforce_metric_name: false
                reject_old_samples: true
                reject_old_samples_max_age: 168h

          promtail:
            enabled: false

          grafana:
            enabled: false

          test_pod:
            enabled: false
          EOF

          helm upgrade --install loki grafana/loki-stack \
            -n ${{ github.event.inputs.namespace }} \
            -f /tmp/loki-values.yaml \
            --timeout 10m || {
              echo "âš ï¸ Helm install failed, checking status..."
            }

          # Wait for Loki to be ready
          echo "â³ Waiting for Loki pod to be ready..."
          sleep 30
          oc get pods -n ${{ github.event.inputs.namespace }} -l app=loki

          oc wait --for=condition=ready pod \
            -l app=loki \
            -n ${{ github.event.inputs.namespace }} \
            --timeout=300s || echo "âš ï¸ Loki may still be starting"

          echo "âœ… Loki deployed"

      - name: Deploy Promtail (Log Collector)
        run: |
          echo "ğŸ“¦ Deploying Promtail (OpenShift-compatible)..."

          # First, grant the necessary SCC
          oc adm policy add-scc-to-user privileged \
            -z promtail \
            -n ${{ github.event.inputs.namespace }} 2>/dev/null || true

          cat <<EOF > /tmp/promtail-values.yaml
          config:
            clients:
              - url: http://loki:3100/loki/api/v1/push
            snippets:
              pipelineStages:
                - cri: {}
              scrapeConfigs: |
                - job_name: kubernetes-pods
                  kubernetes_sd_configs:
                    - role: pod
                  relabel_configs:
                    - source_labels: [__meta_kubernetes_pod_node_name]
                      target_label: node
                    - source_labels: [__meta_kubernetes_namespace]
                      target_label: namespace
                    - source_labels: [__meta_kubernetes_pod_name]
                      target_label: pod
                    - source_labels: [__meta_kubernetes_pod_container_name]
                      target_label: container
                    - source_labels: [__meta_kubernetes_pod_label_app]
                      target_label: app
                    - action: replace
                      source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
                      separator: /
                      replacement: /var/log/pods/*\$1/*.log
                      target_label: __path__

          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi

          containerSecurityContext:
            privileged: true
            runAsUser: 0
            allowPrivilegeEscalation: true

          tolerations:
            - operator: Exists

          serviceAccount:
            create: true
            name: promtail

          rbac:
            create: true
            pspEnabled: false
          EOF

          helm upgrade --install promtail grafana/promtail \
            -n ${{ github.event.inputs.namespace }} \
            -f /tmp/promtail-values.yaml \
            --timeout 5m || echo "âš ï¸ Promtail may need SCC adjustment"

          # Re-apply SCC after helm creates the service account
          sleep 10
          oc adm policy add-scc-to-user privileged \
            -z promtail \
            -n ${{ github.event.inputs.namespace }} || true

          # Restart to pick up SCC
          oc rollout restart daemonset/promtail \
            -n ${{ github.event.inputs.namespace }} 2>/dev/null || true

          sleep 20
          oc get pods -n ${{ github.event.inputs.namespace }} -l app.kubernetes.io/name=promtail

          echo "âœ… Promtail deployed"

      - name: Deploy Prometheus (Optional)
        if: github.event.inputs.install_prometheus == 'true'
        run: |
          echo "ğŸ“¦ Deploying Prometheus (OpenShift-compatible)..."

          cat <<EOF > /tmp/prometheus-values.yaml
          server:
            persistentVolume:
              enabled: true
              size: ${{ github.event.inputs.storage_size }}
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 512Mi
            retention: "7d"

          alertmanager:
            enabled: true
            persistentVolume:
              enabled: false

          pushgateway:
            enabled: false

          nodeExporter:
            enabled: false

          kubeStateMetrics:
            enabled: true

          serverFiles:
            prometheus.yml:
              scrape_configs:
                - job_name: prometheus
                  static_configs:
                    - targets: ['localhost:9090']
                
                - job_name: 'mortgage-services'
                  kubernetes_sd_configs:
                    - role: pod
                      namespaces:
                        names:
                          - ${{ env.APP_NAMESPACE }}
                  relabel_configs:
                    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                      action: keep
                      regex: true
                    - source_labels: [__meta_kubernetes_namespace]
                      target_label: namespace
                    - source_labels: [__meta_kubernetes_pod_name]
                      target_label: pod
                    - source_labels: [__meta_kubernetes_pod_label_app]
                      target_label: app
          EOF

          helm upgrade --install prometheus prometheus-community/prometheus \
            -n ${{ github.event.inputs.namespace }} \
            -f /tmp/prometheus-values.yaml \
            --timeout 10m || echo "âš ï¸ Prometheus may still be deploying"

          echo "âœ… Prometheus deployed"

      - name: Deploy Grafana
        run: |
          echo "ğŸ“¦ Deploying Grafana..."

          cat <<EOF > /tmp/grafana-values.yaml
          adminUser: admin
          adminPassword: "${{ steps.grafana-secret.outputs.password }}"

          persistence:
            enabled: true
            size: 5Gi

          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi

          datasources:
            datasources.yaml:
              apiVersion: 1
              datasources:
                - name: Loki
                  type: loki
                  access: proxy
                  url: http://loki:3100
                  isDefault: true
                  jsonData:
                    maxLines: 1000
          EOF

          # Add Prometheus datasource if installed
          if [ "${{ github.event.inputs.install_prometheus }}" == "true" ]; then
            cat <<EOF >> /tmp/grafana-values.yaml
                - name: Prometheus
                  type: prometheus
                  access: proxy
                  url: http://prometheus-server:80
                  isDefault: false
          EOF
          fi

          cat <<EOF >> /tmp/grafana-values.yaml

          sidecar:
            dashboards:
              enabled: true
              label: grafana_dashboard
              labelValue: "1"
              searchNamespace: ALL
            datasources:
              enabled: true
              label: grafana_datasource

          grafana.ini:
            server:
              root_url: "%(protocol)s://%(domain)s/"
            security:
              admin_user: admin
            auth.anonymous:
              enabled: false
            alerting:
              enabled: true
            unified_alerting:
              enabled: true

          service:
            type: ClusterIP
            port: 80
          EOF

          helm upgrade --install grafana grafana/grafana \
            -n ${{ github.event.inputs.namespace }} \
            -f /tmp/grafana-values.yaml \
            --timeout 5m || echo "âš ï¸ Grafana may still be deploying"

          sleep 20
          oc get pods -n ${{ github.event.inputs.namespace }} -l app.kubernetes.io/name=grafana

          echo "âœ… Grafana deployed"

      - name: Create Grafana Route
        id: grafana-route
        run: |
          echo "ğŸŒ Creating Grafana route..."

          # Check if route exists
          if oc get route grafana -n ${{ github.event.inputs.namespace }} &>/dev/null; then
            echo "Route already exists"
          else
            oc create route edge grafana \
              --service=grafana \
              --port=3000 \
              -n ${{ github.event.inputs.namespace }} || \
            oc expose svc grafana \
              -n ${{ github.event.inputs.namespace }} || true
          fi

          sleep 5
          GRAFANA_URL=$(oc get route grafana -n ${{ github.event.inputs.namespace }} -o jsonpath='{.spec.host}' 2>/dev/null || echo "pending")
          echo "url=https://${GRAFANA_URL}" >> $GITHUB_OUTPUT

          echo "âœ… Grafana route: https://${GRAFANA_URL}"

      - name: Configure RBAC for Promtail
        run: |
          echo "ğŸ” Configuring RBAC..."

          cat <<EOF | oc apply -f -
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: promtail-clusterrole
          rules:
            - apiGroups: [""]
              resources: ["nodes", "nodes/proxy", "services", "endpoints", "pods"]
              verbs: ["get", "watch", "list"]
            - apiGroups: [""]
              resources: ["configmaps"]
              verbs: ["get"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: promtail-clusterrolebinding
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: promtail-clusterrole
          subjects:
            - kind: ServiceAccount
              name: promtail
              namespace: ${{ github.event.inputs.namespace }}
          EOF

          echo "âœ… RBAC configured"

      - name: Verify Deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          echo ""

          echo "Pods in ${{ github.event.inputs.namespace }}:"
          oc get pods -n ${{ github.event.inputs.namespace }}

          echo ""
          echo "Services:"
          oc get svc -n ${{ github.event.inputs.namespace }}

          echo ""
          echo "Routes:"
          oc get routes -n ${{ github.event.inputs.namespace }}

          echo ""
          echo "PVCs:"
          oc get pvc -n ${{ github.event.inputs.namespace }}

      - name: Wait for All Pods Ready
        run: |
          echo "â³ Waiting for pods to be ready..."

          for i in {1..30}; do
            READY=$(oc get pods -n ${{ github.event.inputs.namespace }} --no-headers 2>/dev/null | grep -c "Running" || true)
            TOTAL=$(oc get pods -n ${{ github.event.inputs.namespace }} --no-headers 2>/dev/null | wc -l | tr -d ' ' || true)
            
            # Default to 0 if empty
            READY=${READY:-0}
            TOTAL=${TOTAL:-0}
            
            # Remove any whitespace/newlines
            READY=$(echo "$READY" | tr -d '[:space:]')
            TOTAL=$(echo "$TOTAL" | tr -d '[:space:]')
            
            echo "Ready pods: $READY / $TOTAL"
            
            # Check if at least 2 pods are running (Loki + Grafana minimum)
            if [ -n "$READY" ] && [ "$READY" -ge 2 ] 2>/dev/null; then
              echo "âœ… Core pods are running"
              break
            fi
            sleep 10
          done

          echo ""
          echo "Final pod status:"
          oc get pods -n ${{ github.event.inputs.namespace }}

      - name: Summary
        run: |
          echo "## ğŸ‰ Grafana Stack Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Grafana URL | ${{ steps.grafana-route.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Username | \`admin\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Password | \`${{ steps.grafana-secret.outputs.password }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Components Installed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Purpose | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Grafana | Visualization & Dashboards | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Loki | Log Aggregation | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Promtail | Log Collection | âœ… |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.install_prometheus }}" == "true" ]; then
            echo "| Prometheus | Metrics Collection | âœ… |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Run **Configure Microservices Logging** workflow" >> $GITHUB_STEP_SUMMARY
          echo "2. Run **Create Grafana Dashboards** workflow" >> $GITHUB_STEP_SUMMARY
          echo "3. Run **Create Grafana Alerts** workflow" >> $GITHUB_STEP_SUMMARY

      - name: Output Credentials
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… GRAFANA STACK DEPLOYED SUCCESSFULLY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  Grafana URL: ${{ steps.grafana-route.outputs.url }}"
          echo "  Username:    admin"
          echo "  Password:    ${{ steps.grafana-secret.outputs.password }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
