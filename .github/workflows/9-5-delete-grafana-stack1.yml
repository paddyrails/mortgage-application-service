name: 9.5 Delete Grafana Stack

# ============================================================
# Deletes Grafana observability stack from OpenShift:
# - Grafana (Helm release)
# - Loki (YAML deployment)
# - Promtail (YAML DaemonSet)
# - All related PVCs, ConfigMaps, Secrets, RBAC
# ============================================================

on:
  workflow_dispatch:
    inputs:
      monitoring_namespace:
        description: "Namespace where Grafana stack is deployed"
        required: true
        default: "monitoring"
      confirm_namespace:
        description: "Type namespace name again to confirm deletion"
        required: true
      delete_pvcs:
        description: "Also delete Persistent Volume Claims (data will be lost!)"
        required: true
        default: false
        type: boolean
      delete_namespace:
        description: "Delete the entire namespace"
        required: true
        default: false
        type: boolean

jobs:
  delete-grafana-stack:
    name: Delete Grafana Stack
    runs-on: ubuntu-latest

    steps:
      - name: Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.monitoring_namespace }}" != "${{ github.event.inputs.confirm_namespace }}" ]; then
            echo "âŒ Confirmation failed!"
            echo "   Expected: ${{ github.event.inputs.monitoring_namespace }}"
            echo "   Got: ${{ github.event.inputs.confirm_namespace }}"
            exit 1
          fi
          echo "âœ… Confirmed deletion of namespace: ${{ github.event.inputs.monitoring_namespace }}"

      - name: Install Tools
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Login to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify=true

      - name: List Resources Before Deletion
        run: |
          echo "ðŸ“‹ Current resources in ${{ github.event.inputs.monitoring_namespace }}:"
          echo ""
          echo "=== Helm Releases ==="
          helm list -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || echo "No Helm releases"
          echo ""
          echo "=== Pods ==="
          oc get pods -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || echo "No pods"
          echo ""
          echo "=== Services ==="
          oc get svc -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || echo "No services"
          echo ""
          echo "=== PVCs ==="
          oc get pvc -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || echo "No PVCs"

      - name: Delete Grafana (Helm)
        run: |
          echo "ðŸ—‘ï¸ Deleting Grafana Helm release..."
          helm uninstall grafana -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "âœ… Grafana deleted" || echo "âš ï¸ Grafana not found or already deleted"

      - name: Delete Loki (YAML Deployment)
        run: |
          echo "ðŸ—‘ï¸ Deleting Loki..."

          # Delete Loki deployment
          oc delete deployment loki -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "âœ… Loki deployment deleted" || echo "âš ï¸ Loki deployment not found"

          # Delete Loki service
          oc delete service loki -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "âœ… Loki service deleted" || echo "âš ï¸ Loki service not found"

          # Delete Loki configmap
          oc delete configmap loki-config -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "âœ… Loki configmap deleted" || echo "âš ï¸ Loki configmap not found"

      - name: Delete Promtail (YAML DaemonSet)
        run: |
          echo "ðŸ—‘ï¸ Deleting Promtail..."

          # Delete Promtail daemonset
          oc delete daemonset promtail -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "âœ… Promtail daemonset deleted" || echo "âš ï¸ Promtail daemonset not found"

          # Delete Promtail configmap
          oc delete configmap promtail-config -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "âœ… Promtail configmap deleted" || echo "âš ï¸ Promtail configmap not found"

          # Delete Promtail service account
          oc delete serviceaccount promtail -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "âœ… Promtail SA deleted" || echo "âš ï¸ Promtail SA not found"

      - name: Delete Routes
        run: |
          echo "ðŸ—‘ï¸ Deleting routes..."
          oc delete route grafana -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "âœ… Grafana route deleted" || echo "âš ï¸ Grafana route not found"

      - name: Delete Secrets and ConfigMaps
        run: |
          echo "ðŸ—‘ï¸ Deleting secrets and configmaps..."

          oc delete secret grafana-admin-credentials -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || true
          oc delete configmap promtail-mortgage-config -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || true

          echo "âœ… Secrets and configmaps deleted"

      - name: Delete RBAC Resources
        run: |
          echo "ðŸ—‘ï¸ Deleting RBAC resources..."

          # Delete ClusterRoleBinding
          oc delete clusterrolebinding promtail-clusterrolebinding 2>/dev/null && echo "âœ… ClusterRoleBinding deleted" || echo "âš ï¸ ClusterRoleBinding not found"

          # Delete ClusterRole
          oc delete clusterrole promtail-clusterrole 2>/dev/null && echo "âœ… ClusterRole deleted" || echo "âš ï¸ ClusterRole not found"

          # Remove SCC from promtail service account
          oc adm policy remove-scc-from-user privileged -z promtail -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || true

      - name: Delete PVCs
        if: github.event.inputs.delete_pvcs == 'true'
        run: |
          echo "ðŸ—‘ï¸ Deleting PVCs (data will be permanently lost!)..."

          # Delete Loki PVC
          oc delete pvc loki-data -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "âœ… Loki PVC deleted" || echo "âš ï¸ Loki PVC not found"

          # Delete any Grafana PVCs
          oc delete pvc -l app.kubernetes.io/name=grafana -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || true

          # Delete any remaining PVCs
          oc delete pvc --all -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || true

          echo "âœ… All PVCs deleted"

      - name: Delete Namespace
        if: github.event.inputs.delete_namespace == 'true'
        run: |
          echo "ðŸ—‘ï¸ Deleting namespace ${{ github.event.inputs.monitoring_namespace }}..."

          oc delete namespace ${{ github.event.inputs.monitoring_namespace }} --timeout=120s 2>/dev/null && echo "âœ… Namespace deleted" || echo "âš ï¸ Namespace deletion may be in progress"

      - name: Verify Deletion
        run: |
          echo "ðŸ” Verifying deletion..."
          echo ""

          if [ "${{ github.event.inputs.delete_namespace }}" == "true" ]; then
            # Check if namespace still exists
            if oc get namespace ${{ github.event.inputs.monitoring_namespace }} &>/dev/null; then
              echo "âš ï¸ Namespace still exists (may be terminating)"
              oc get namespace ${{ github.event.inputs.monitoring_namespace }}
            else
              echo "âœ… Namespace deleted successfully"
            fi
          else
            echo "Remaining resources in ${{ github.event.inputs.monitoring_namespace }}:"
            oc get all -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || echo "Namespace may not exist"
            echo ""
            echo "Remaining PVCs:"
            oc get pvc -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || echo "No PVCs"
          fi

      - name: Summary
        run: |
          echo "## ðŸ—‘ï¸ Grafana Stack Deleted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deleted Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Grafana | Helm Release | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
          echo "| Loki | Deployment | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
          echo "| Loki | Service | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
          echo "| Loki | ConfigMap | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
          echo "| Promtail | DaemonSet | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
          echo "| Promtail | ConfigMap | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
          echo "| Promtail | ServiceAccount | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
          echo "| Promtail | ClusterRole | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
          echo "| Promtail | ClusterRoleBinding | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
          echo "| Grafana | Route | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
          echo "| Grafana | Secret | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.delete_pvcs }}" == "true" ]; then
            echo "| All | PVCs | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| All | PVCs | â­ï¸ Preserved |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.event.inputs.delete_namespace }}" == "true" ]; then
            echo "| monitoring | Namespace | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Namespace" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Name**: \`${{ github.event.inputs.monitoring_namespace }}\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.delete_namespace }}" == "true" ]; then
            echo "- **Status**: Deleted" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: Preserved (can be reused)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To redeploy the Grafana stack, run the **Deploy Grafana Stack** workflow." >> $GITHUB_STEP_SUMMARY
