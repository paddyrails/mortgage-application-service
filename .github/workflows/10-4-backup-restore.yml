name: Database Backup/Restore

# ============================================================
# Backup and restore PostgreSQL database
# Backups are stored as GitHub artifacts
# ============================================================

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - backup
          - restore
      namespace:
        description: 'Namespace'
        required: true
        default: 'mortgage-app'
      backup_name:
        description: 'Backup name (for restore, use artifact name)'
        required: false
        default: ''
  schedule:
    # Daily backup at 2 AM UTC
    - cron: '0 2 * * *'

env:
  DB_NAME: mortgage_db

jobs:
  backup:
    name: Backup Database
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'backup' || github.event_name == 'schedule'

    steps:
      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify=true

      - name: Create Backup
        run: |
          echo "üì¶ Creating database backup..."
          
          NAMESPACE="${{ github.event.inputs.namespace || 'mortgage-app' }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BACKUP_NAME="mortgage-db-backup-${TIMESTAMP}"
          
          POD=$(oc get pod -n $NAMESPACE -l app=postgresql -o jsonpath='{.items[0].metadata.name}')
          
          if [ -z "$POD" ]; then
            echo "‚ùå PostgreSQL pod not found"
            exit 1
          fi
          
          echo "Pod: $POD"
          echo "Creating backup: $BACKUP_NAME"
          
          # Create full database dump
          oc exec -n $NAMESPACE $POD -- pg_dump -U postgres -d ${{ env.DB_NAME }} -Fc -f /tmp/backup.dump
          
          # Copy to local
          oc cp $NAMESPACE/$POD:/tmp/backup.dump ./${BACKUP_NAME}.dump
          
          # Also create SQL version for readability
          oc exec -n $NAMESPACE $POD -- pg_dump -U postgres -d ${{ env.DB_NAME }} --schema-only -f /tmp/schema.sql
          oc cp $NAMESPACE/$POD:/tmp/schema.sql ./${BACKUP_NAME}-schema.sql
          
          # Create backup info
          cat <<EOF > ${BACKUP_NAME}-info.txt
          Backup Information
          ==================
          Timestamp: $(date -Iseconds)
          Database: ${{ env.DB_NAME }}
          Namespace: $NAMESPACE
          Pod: $POD
          
          Schemas included:
          - customer_service
          - property_service
          - loans_service
          - payments_service
          - application_service
          
          Files:
          - ${BACKUP_NAME}.dump (pg_dump custom format)
          - ${BACKUP_NAME}-schema.sql (schema only, readable)
          EOF
          
          ls -la ${BACKUP_NAME}*
          echo "backup_name=$BACKUP_NAME" >> $GITHUB_ENV

      - name: Upload Backup Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.backup_name }}
          path: |
            ${{ env.backup_name }}.dump
            ${{ env.backup_name }}-schema.sql
            ${{ env.backup_name }}-info.txt
          retention-days: 30

      - name: Summary
        run: |
          echo "## üíæ Database Backup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backup Name | \`${{ env.backup_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Database | \`${{ env.DB_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Retention | 30 days |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download from the Artifacts section below." >> $GITHUB_STEP_SUMMARY

  restore:
    name: Restore Database
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'restore'

    steps:
      - name: Validate Input
        run: |
          if [ -z "${{ github.event.inputs.backup_name }}" ]; then
            echo "‚ùå Backup name is required for restore"
            exit 1
          fi

      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify=true

      - name: Download Backup Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.inputs.backup_name }}
          path: ./backup

      - name: Restore Database
        run: |
          echo "üîÑ Restoring database from backup..."
          
          NAMESPACE="${{ github.event.inputs.namespace }}"
          POD=$(oc get pod -n $NAMESPACE -l app=postgresql -o jsonpath='{.items[0].metadata.name}')
          
          ls -la ./backup/
          
          DUMP_FILE=$(ls ./backup/*.dump | head -1)
          
          if [ -z "$DUMP_FILE" ]; then
            echo "‚ùå No .dump file found in backup"
            exit 1
          fi
          
          echo "Restoring from: $DUMP_FILE"
          
          # Copy backup to pod
          oc cp $DUMP_FILE $NAMESPACE/$POD:/tmp/restore.dump
          
          # Restore database
          echo "‚ö†Ô∏è This will overwrite existing data!"
          oc exec -n $NAMESPACE $POD -- pg_restore -U postgres -d ${{ env.DB_NAME }} --clean --if-exists /tmp/restore.dump || {
            echo "‚ö†Ô∏è Some errors during restore (may be normal for clean database)"
          }
          
          echo "‚úÖ Restore complete"

      - name: Verify Restore
        run: |
          echo "üîç Verifying restore..."
          
          NAMESPACE="${{ github.event.inputs.namespace }}"
          POD=$(oc get pod -n $NAMESPACE -l app=postgresql -o jsonpath='{.items[0].metadata.name}')
          
          echo "=== Schemas ==="
          oc exec -n $NAMESPACE $POD -- psql -U postgres -d ${{ env.DB_NAME }} -c "\dn"
          
          echo ""
          echo "=== Tables per Schema ==="
          for SCHEMA in customer_service property_service loans_service payments_service application_service; do
            echo "--- $SCHEMA ---"
            oc exec -n $NAMESPACE $POD -- psql -U postgres -d ${{ env.DB_NAME }} -c "SELECT table_name FROM information_schema.tables WHERE table_schema = '$SCHEMA';"
          done

      - name: Summary
        run: |
          echo "## üîÑ Database Restore Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Restored from: \`${{ github.event.inputs.backup_name }}\`" >> $GITHUB_STEP_SUMMARY
