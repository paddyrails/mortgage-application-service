name: 3. Verify Health Checks

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options: [dev, staging, prod]

env:
  SERVICE_NAME: application-service
  OPENSHIFT_NAMESPACE: mortgage-app

jobs:
  verify-health:
    runs-on: ubuntu-latest

    steps:
      - uses: redhat-actions/openshift-tools-installer@v1
        with:
          oc: "4.14"

      - uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true
          namespace: ${{ env.OPENSHIFT_NAMESPACE }}

      - name: Get Service URL
        id: url
        run: |
          ROUTE=$(oc get route ${{ env.SERVICE_NAME }} -o jsonpath='{.spec.host}')
          echo "url=https://${ROUTE}" >> $GITHUB_OUTPUT
          echo "ðŸŒ Service URL: https://${ROUTE}"

      - name: Check Pod Status
        run: |
          echo "ðŸ“Š Pod Status:"
          oc get pods -l app=${{ env.SERVICE_NAME }} -n ${{ env.OPENSHIFT_NAMESPACE }} -o wide

      - name: Verify Liveness
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.url.outputs.url }}/api/health/live" --max-time 30)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Liveness: PASSED"
          else
            echo "âŒ Liveness: FAILED (HTTP ${HTTP_CODE})"
            exit 1
          fi

      - name: Verify Readiness (All Dependencies)
        run: |
          echo "ðŸ”— Checking readiness (validates all 4 dependencies)..."
          RESPONSE=$(curl -s "${{ steps.url.outputs.url }}/api/health/ready" --max-time 30)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.url.outputs.url }}/api/health/ready" --max-time 30)
          
          echo ""
          echo "Response:"
          echo "$RESPONSE" | jq .
          echo ""
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Readiness: PASSED - All dependencies healthy"
          elif [ "$HTTP_CODE" = "503" ]; then
            echo "âš ï¸ Readiness: DEGRADED - Some dependencies unhealthy"
            echo "Check the Dependencies section in the response above."
          else
            echo "âŒ Readiness: FAILED (HTTP ${HTTP_CODE})"
            exit 1
          fi

      - name: Check Main Health
        run: |
          echo "ðŸ¥ Main Health Endpoint:"
          curl -s "${{ steps.url.outputs.url }}/api/health" | jq .

      - name: Check All Service Routes
        run: |
          echo "ðŸ“¡ All Mortgage Services Status:"
          echo ""
          
          for svc in customer-service property-service loans-service payments-service application-service; do
            ROUTE=$(oc get route $svc -n ${{ env.OPENSHIFT_NAMESPACE }} -o jsonpath='{.spec.host}' 2>/dev/null || echo "")
            if [ -n "$ROUTE" ]; then
              HTTP=$(curl -s -o /dev/null -w "%{http_code}" "https://${ROUTE}/api/health" --max-time 10 || echo "000")
              if [ "$HTTP" = "200" ]; then
                echo "âœ… $svc: https://${ROUTE} (HTTP $HTTP)"
              else
                echo "âš ï¸ $svc: https://${ROUTE} (HTTP $HTTP)"
              fi
            else
              echo "âŒ $svc: Route not found"
            fi
          done

      - name: Summary
        run: |
          echo "## ðŸ¥ Application Service Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Liveness | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Readiness | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Service Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- customer-service" >> $GITHUB_STEP_SUMMARY
          echo "- property-service" >> $GITHUB_STEP_SUMMARY
          echo "- loans-service" >> $GITHUB_STEP_SUMMARY
          echo "- payments-service" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "URL: ${{ steps.url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
