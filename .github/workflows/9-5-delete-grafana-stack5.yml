name: 9.5 Delete Grafana Stack

# ============================================================
# Deletes Grafana observability stack from OpenShift:
# - Grafana (Deployment, Service, Route)
# - Loki (Deployment, Service)
# - Promtail (DaemonSet)
# - Service Accounts and SCCs
# - All related PVCs, ConfigMaps, Secrets, RBAC
# ============================================================

on:
  workflow_dispatch:
    inputs:
      monitoring_namespace:
        description: "Namespace where Grafana stack is deployed"
        required: true
        default: "monitoring"
      confirm_namespace:
        description: "Type namespace name again to confirm deletion"
        required: true
      delete_pvcs:
        description: "Also delete Persistent Volume Claims (data will be lost!)"
        required: true
        default: true
        type: boolean
      delete_namespace:
        description: "Delete the entire namespace"
        required: true
        default: false
        type: boolean

jobs:
  delete-grafana-stack:
    name: Delete Grafana Stack
    runs-on: ubuntu-latest

    steps:
      - name: Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.monitoring_namespace }}" != "${{ github.event.inputs.confirm_namespace }}" ]; then
            echo "❌ Confirmation failed!"
            echo "   Expected: ${{ github.event.inputs.monitoring_namespace }}"
            echo "   Got: ${{ github.event.inputs.confirm_namespace }}"
            exit 1
          fi
          echo "✅ Confirmed deletion of namespace: ${{ github.event.inputs.monitoring_namespace }}"

      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify=true

      - name: List Resources Before Deletion
        run: |
          echo "📋 Current resources in ${{ github.event.inputs.monitoring_namespace }}:"
          echo ""
          echo "=== Pods ==="
          oc get pods -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || echo "No pods or namespace doesn't exist"
          echo ""
          echo "=== Services ==="
          oc get svc -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || echo "No services"
          echo ""
          echo "=== PVCs ==="
          oc get pvc -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || echo "No PVCs"
          echo ""
          echo "=== Service Accounts ==="
          oc get sa -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || echo "No service accounts"

      - name: Delete Grafana
        run: |
          echo "🗑️ Deleting Grafana..."

          oc delete deployment grafana -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Grafana deployment deleted" || echo "⚠️ Not found"
          oc delete service grafana -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Grafana service deleted" || echo "⚠️ Not found"
          oc delete route grafana -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Grafana route deleted" || echo "⚠️ Not found"
          oc delete configmap grafana-datasources -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Grafana datasources deleted" || echo "⚠️ Not found"
          oc delete secret grafana-admin -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Grafana secret deleted" || echo "⚠️ Not found"

      - name: Delete Loki
        run: |
          echo "🗑️ Deleting Loki..."

          oc delete deployment loki -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Loki deployment deleted" || echo "⚠️ Not found"
          oc delete service loki -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Loki service deleted" || echo "⚠️ Not found"
          oc delete configmap loki-config -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Loki configmap deleted" || echo "⚠️ Not found"

      - name: Delete Promtail
        run: |
          echo "🗑️ Deleting Promtail..."

          oc delete daemonset promtail -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Promtail daemonset deleted" || echo "⚠️ Not found"
          oc delete configmap promtail-config -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Promtail configmap deleted" || echo "⚠️ Not found"

      - name: Remove SCCs from Service Accounts
        run: |
          echo "🔐 Removing Security Context Constraints..."

          oc adm policy remove-scc-from-user anyuid -z loki -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Removed anyuid from loki" || echo "⚠️ Not found"
          oc adm policy remove-scc-from-user anyuid -z grafana -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Removed anyuid from grafana" || echo "⚠️ Not found"
          oc adm policy remove-scc-from-user privileged -z promtail -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Removed privileged from promtail" || echo "⚠️ Not found"

      - name: Delete Service Accounts
        run: |
          echo "🗑️ Deleting Service Accounts..."

          oc delete sa loki -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Loki SA deleted" || echo "⚠️ Not found"
          oc delete sa grafana -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Grafana SA deleted" || echo "⚠️ Not found"
          oc delete sa promtail -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Promtail SA deleted" || echo "⚠️ Not found"

      - name: Delete Cluster RBAC Resources
        run: |
          echo "🗑️ Deleting Cluster RBAC resources..."

          oc delete clusterrolebinding promtail 2>/dev/null && echo "✅ ClusterRoleBinding deleted" || echo "⚠️ Not found"
          oc delete clusterrole promtail 2>/dev/null && echo "✅ ClusterRole deleted" || echo "⚠️ Not found"

      - name: Delete PVCs
        if: github.event.inputs.delete_pvcs == 'true'
        run: |
          echo "🗑️ Deleting PVCs (data will be permanently lost!)..."

          oc delete pvc loki-data -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Loki PVC deleted" || echo "⚠️ Not found"
          oc delete pvc grafana-data -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null && echo "✅ Grafana PVC deleted" || echo "⚠️ Not found"

          # Delete any remaining PVCs
          oc delete pvc --all -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || true

          echo "✅ All PVCs deleted"

      - name: Delete Namespace
        if: github.event.inputs.delete_namespace == 'true'
        run: |
          echo "🗑️ Deleting namespace ${{ github.event.inputs.monitoring_namespace }}..."

          oc delete namespace ${{ github.event.inputs.monitoring_namespace }} --timeout=120s 2>/dev/null && echo "✅ Namespace deleted" || echo "⚠️ Namespace deletion may be in progress"

      - name: Verify Deletion
        run: |
          echo "🔍 Verifying deletion..."
          echo ""

          if [ "${{ github.event.inputs.delete_namespace }}" == "true" ]; then
            if oc get namespace ${{ github.event.inputs.monitoring_namespace }} &>/dev/null; then
              echo "⚠️ Namespace still exists (may be terminating)"
              oc get namespace ${{ github.event.inputs.monitoring_namespace }}
            else
              echo "✅ Namespace deleted successfully"
            fi
          else
            echo "Remaining resources in ${{ github.event.inputs.monitoring_namespace }}:"
            oc get all -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || echo "No resources found"
            echo ""
            echo "Remaining PVCs:"
            oc get pvc -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || echo "No PVCs"
            echo ""
            echo "Remaining Service Accounts:"
            oc get sa -n ${{ github.event.inputs.monitoring_namespace }} 2>/dev/null || echo "Only default SA"
          fi

      - name: Summary
        run: |
          echo "## 🗑️ Grafana Stack Deleted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deleted Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Resources Deleted |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Grafana | Deployment, Service, Route, ConfigMap, Secret, SA |" >> $GITHUB_STEP_SUMMARY
          echo "| Loki | Deployment, Service, ConfigMap, SA |" >> $GITHUB_STEP_SUMMARY
          echo "| Promtail | DaemonSet, ConfigMap, SA, ClusterRole, ClusterRoleBinding |" >> $GITHUB_STEP_SUMMARY
          echo "| SCCs | anyuid (loki, grafana), privileged (promtail) |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.delete_pvcs }}" == "true" ]; then
            echo "| PVCs | loki-data, grafana-data |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| PVCs | ⏭️ Preserved |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.event.inputs.delete_namespace }}" == "true" ]; then
            echo "| Namespace | ${{ github.event.inputs.monitoring_namespace }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To redeploy, run the **Deploy Grafana Stack** workflow." >> $GITHUB_STEP_SUMMARY

          echo ""
          echo "════════════════════════════════════════════════════════════"
          echo "  ✅ GRAFANA STACK DELETED"
          echo "════════════════════════════════════════════════════════════"
